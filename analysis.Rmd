---
title: "Many Analystis Project"
description: 
author:
  - name: Joseph Bulbulia
    url: https://josephbulbulia.netlify.app
    affiliation: Victoria University of Wellington
    affiliation_url: https://www.wgtn.ac.nz
    orcid_id: 0000-0002-5861-2056
date: 2021-APRIL-29 
bibliography: references.bib
link-citations: true
output:
  distill::distill_article:
    self_contained: true
    toc: true
    code_folding: true
    highlight: kate
editor_options: 
  chunk_output_type: console
---

```{r global_options, echo=FALSE, include = FALSE}
knitr::opts_chunk$set(#
  fig.path="Figs/", 
  message=FALSE, 
  warning=FALSE,
  collapse =TRUE,
  echo=TRUE, 
  #results="hide", 
  fig.width= 16,
  fig.height= 9)
```

```{r runanalysis, echo=FALSE, include = FALSE}
# source("libs.R") # libraries 
# source("funs.R") # custom functions
library("tidyverse")
library("easystats")
library("ggplot2") #plots
library("sjstats") #test statistics
library("sjPlot")
library("sjmisc")
library("insight")
library("see")
library("performance")
library("ggraph")
library("parameters")
library("lme4")
library("psych") ## correlation matrix
library("table1")
library("ggeffects")
library("gghighlight")
library("texreg")
library("kableExtra")
#library("naniar") # missingness
#library("Amelia")
#library("magrittr")
library("patchwork")
library("texreg")
library("viridisLite")
library("patchwork")
library("here")
#library("rethinking")
#library("statsExpressions")
#library("ggstatsplot")
library("ggthemes")
library("ggdag")
library("rstan")
library("brms")
library("tidybayes")
library("bayesplot")
library("dagitty")
library("ggdag")
library("geepack")  # marginal structural models
library("ipw") # inverse probability weighting. 
library("WeightIt")# inverse probability weighting. 
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores ())
theme_set(theme_few())
```

## Workflow and analysis

First, we import the data (see functions). [@tchetgen2012]

```{r}
# import data
d <- as.data.frame(
  read.csv(here::here("MARP_data.csv")
  )
)
```

```{r cache = TRUE}
# clean data:use informative names !
# note from Suzanne: 
# I do think it's actually a negative relation, as the anxiety item was reverse-coded (following the documentation from the WHO quality of life scale, from which the items were taken). This is indicated in the data documentation, but I can totally understand this got buried under all information that was provided. We tried to make the dataset as clean as possible since most teams just aggregated all well-being items (and the religiosity items). But in retrospect, this recoding did cause some confusion for a couple of teams that used only specific items (and prefered the ordinal scale). This is definitely something to take into account for future projects like this one. 

df <- d %>%
  dplyr::mutate(male2 = ifelse(gender != "man", 1 , 2)) %>% # for index categorical variable, not change of meaning for gender. male and people who do not identify as male.
  dplyr::mutate(male = factor(ifelse(gender != "man", "male" , "notmale"))) %>%
  rename(
    rel_CHURCHFREQ   = rel_1,
    # factor need to recode (eg 7 as 0)// yikes factor transformed into a number
    rel_PRAYERFREQ = rel_2,
    # factor need to recode (eg. 7 as 0)// yikes factor transformed into a number
    IS_RELIIGOUS = rel_3,
    # factor 1 = yes, 2 = no, 3 = atheist// yikes factor transformed into a number
    BELONGS_DENOMINATION = rel_4,
    # relig
    rel_EXTENTBELIEVEGOD = rel_5,
    # do you belong to a religion or religious denomination? 1 = yes, 2 = no (!)
    rel_EXTENTBELIEVEAFTERLIFE = rel_6,
    rel_EXTENTSPIRITUAL  = rel_7,
    rel_IMPORTANCERELIGIOUSLIFE = rel_8,
    # 1 to five
    rel_IMPORTANCEBELIEVEGOD = rel_9,
    # 1 to five
    wb_genLIFEQUALITY = wb_gen_1,
    # not defined # also remove second underscore, which BRMS doesn't like
    wb_genSATHEALTH = wb_gen_2,
    # not defined
    wb_phyPAIN = wb_phys_1,
    wb_physNEEDSMEDICALTREAT =  wb_phys_2,
    wb_physHASENERGY =  wb_phys_3,
    wb_physMOBILITY = wb_phys_4,
    wb_physSLEEP = wb_phys_5,
    wb_physCANDODAILYACTIVITIES  = wb_phys_6,
    wb_physSATCAPACITYWORK  = wb_phys_7,
    wb_psychENJOYLIFE = wb_psych_1,
    wb_psychMEANING  = wb_psych_2,
    wb_psychCONCENTRATE  = wb_psych_3,
    wb_psychLIKESAPPEARANCE  = wb_psych_4,
    wb_psychSATSELF  = wb_psych_5,
    wb_psychANXIETY  = wb_psych_6,
    wb_socSATPERSONALRELATIONSHIPS  = wb_soc_1,
    wb_socSATSUPPORTFRIENDS  = wb_soc_2
    #   wb_socSATSEX   = wb_soc_3,
  ) %>%
  dplyr::mutate(
    IS_RELIIGOUS = as.factor(IS_RELIIGOUS),
    denomination = as.factor(denomination),
    ethnicity = as.factor(ethnicity),
    country = as.factor(country)
  ) %>%
  dplyr::mutate(
    IS_RELIIGOUS = recode_factor(
      IS_RELIIGOUS,
      "0" = "atheist",
      "0.5" = "not_religious",
      "1" = "religious"
    )
  )


```

```{r}
# get data into shape
d1 <- df %>%
  dplyr::filter(
    !is.na(wb_psychANXIETY),
    !is.na(age),
    !is.na(rel_CHURCHFREQ),
   # !is.na(wb_psychMEANING),
    !is.na(male),
    !is.na(rel_EXTENTBELIEVEGOD),
  ) %>%
  dplyr::mutate(
    anx = as.integer(6- wb_psychANXIETY), # reverse coded! rescale 1-5
    anx_s = scale(anx),
    #put outcome in ST units (see McElreath 2021)  # not necessary
    age_s = scale(age),
    ch = rel_CHURCHFREQ,
    mn  = wb_psychMEANING,
    bg =  rel_EXTENTBELIEVEGOD,
    ch_s = scale(rel_CHURCHFREQ),
    mn_s = scale(wb_psychMEANING),
    bg_s = scale(rel_EXTENTBELIEVEGOD)
  ) %>%
  dplyr::select(anx,
                ch,
                mn,
                bg,
                anx_s,
                age_s,
                ch_s,
                mn_s,
                male2,
                country,
                male,
                bg_s,
                wb_psychANXIETY)

## degroup variables for within and between analysis
## https://cran.r-project.org/web/packages/parameters/vignettes/demean.html
d1 <-
  cbind(d1,
        parameters::demean(d1, select = c("anx", "ch", "bg"), group = "country"))

hist(d1$anx)
```

## Causal Model: belief in God

```{r}
library("ggdag")
library("dagitty")
dg1a <- dagify(
  anx  ~ belief + church + male + country + U,
  belief ~ age + male + country + church + U,
  church ~ age + male + country + U,
  ses ~ country + age + edu,
  edu ~ country + male, 
  U ~ age + ses + country,
  exposure =  "belief",
  outcome =   "anx",
  latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events"
  )
) #%>%
 # tidy_dagitty()       

d0a <-ggdag::ggdag(dg1a, text = FALSE, use_labels = "label")  + theme_dag() + ggtitle("What if we were to assume distressing events increase belief in God?")
d0a
# graph adjustment sets

d1a<-ggdag::ggdag_adjustment_set(dg1a, node_size = 14, text = FALSE, use_labels = "label") +
  theme(legend.position = "bottom") +
  theme_dag() + ggtitle("If we assume distressing events affect belief and service we cannot estimate causal effects ")

d1a 


dg1 <- dagify(
  anx  ~ belief + church + male + country + U,
  belief ~ age + male + country + church + U,
  church ~ age + male + country + U,
  ses ~ country + age + edu,
  edu ~ country + male, 
  U ~ age + ses + country,
  exposure =  "belief",
  outcome =   "anx",
  latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events",
    coords = list(x = c(anx =6 , 
                        belief = 5, 
                        church = 4, 
                        ses = 3,
                        male = 2, 
                        age = 2,
                        country = 2,
                        U = 1),
                  y = c(anx = 2, 
                        belief = 2, 
                        church = 2, 
                        ses = 2,
                        male = 2, 
                        age = 2,
                        country = 1,
                        U = 1)) #%>%#%>%
 # tidy_dagitty()       
# 
dp0 <-ggdag::ggdag(dg1, text = FALSE, use_labels = "label")  + theme_dag() + ggtitle("Assumed unmeasured causal effects of distressing experiences")

dp0
# # graph adjustment sets
# 
#dp1<-ggdag::ggdag_adjustment_set(dg1, node_size = 14, text = FALSE, use_labels = "label") +
#   theme(legend.position = "bottom") +
#   theme_dag() + ggtitle("Adjustment sets for Belief in God")
#dp1
dp0
```

## Causal model: religious service

We condition on the following model:

-   religion + ses + male + country + a different unmeasured latent variable1 (e.g. privilege) affects distress.

-   age + male + country + and unmeasured latent variable2 (e.g. parent's religion, call this U1) affects Religion

-   country + age + an unmeasured latent variable1 causes ses (citations...)

-   our "exposure" is religious service attendance or religious belief and our outcome is "anxiety"

```{r}
library("ggdag")
dg2 <- dagify( 
  anx  ~ belief + church + male + country + U,
  belief ~ age + male + country + church,
  church ~ age + male + country,
  ses ~ country + age + edu,
  edu ~ country + male, 
  U ~ age + ses + country,
  exposure =  "church",
  outcome =   "anx",
  latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events"
  )
) %>%
  tidy_dagitty()  

ggdag::ggdag(dg2) + theme_dag()

nocause <- ggdag::ggdag(dg2, text = FALSE, use_labels = "label")  + theme_dag() + labs(title = "Assume unmeasured distressing experience does not affect Belief or Service")
nocause

dg0<-ggdag::ggdag_adjustment_set(dg2, node_size = 14, text = FALSE, use_labels = "label") +
  theme(legend.position = "bottom") +
  theme_dag() + ggtitle("Adjustment set for religious service
assuming service does not change from distress")

dp0


dpz <- dagify(
  anx  ~ belief + church + male + country + U,
  belief ~ age + male + country + church,
  church ~ age + male + country,
  ses ~ country + age + edu,
  edu ~ country + male, 
  U ~ age + ses + country,
  exposure =  "belief",
  outcome =   "anx",
  latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events"
  )
)

ggdag::ggdag(dpz) + theme_dag()


# graph adjustment sets
dg1<-ggdag::ggdag_adjustment_set(dpz, node_size = 14, text = FALSE, use_labels = "label") +
  theme(legend.position = "bottom") +
  theme_dag() + ggtitle("Adjustment set for religious belief
assuming belief does not change from distress")

dg1
```

Save image

```{r dg1, eval=FALSE}
# save graph
ggsave(
  dg1,
  path = here::here("Figs"),
  width = 10,
  height = 5,
  units = "in",
  filename = "dag_belief.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)

```


```{r dp0, eval=FALSE}
# save graph
ggsave(
  dg1,
  path = here::here("Figs"),
  width = 10,
  height = 5,
  units = "in",
  filename = "dag_church.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)

```




Graph for paper

## Anxiety causes belief DAG

```{r}
dpL <- dagify(
  anx  ~  church + male + country + U,
  belief ~ age + male + country + church + anx,
  church ~ age + male + country,
  ses ~ country + age + edu,
  edu ~ country + male, 
  U ~ age + ses + country,
  exposure =  "anx",
  outcome =   "belief",
  latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events"
  )
) %>%
  tidy_dagitty()  

dl <- ggdag::ggdag(dpL, text = F, use_labels = "label") + theme_dag()
dl1<- dl + labs(title ="Assume Anxiety causes Belief in God")
dl1

dl2<-ggdag::ggdag_adjustment_set(dpL, node_size = 14, text = FALSE, use_labels = "label") +
  theme(legend.position = "bottom") +
  theme_dag() + ggtitle("Adjustment set assuming anxiety causes belief in God")
dl2


```

## Anxiety causes church DAG

```{r}
dpC <- dagify(
  anx  ~   male + country + U,
  belief ~ age + male + country + church + anx,
  church ~ age + male + country,
  ses ~ country + age + edu,
  edu ~ country + male, 
  U ~ age + ses + country,
  exposure =  "anx",
  outcome =   "church",
  latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events"
  )
) %>%
  tidy_dagitty()  

dC <- ggdag::ggdag(dpC, text = F, use_labels = "label") + theme_dag()
dlC<- dC + labs(title ="Assume Anxiety causes Religious Service")
dlC

dl2C<-ggdag::ggdag_adjustment_set(dpC, node_size = 14, text = FALSE, use_labels = "label") +
  theme(legend.position = "bottom") +
  theme_dag() + ggtitle("Adjustment set for Anxiety causing Religious Service")
dl2C




```

## Dag graph

```{r}
library(patchwork)
 (dp0 + d1a)/   (nocause + dg1 + dp2)  /(dl1 + dl2 + dl2C)+   plot_layout(guides = 'collect')  + plot_annotation(title = 'Three causal models', tag_levels = "a") 
# dag_ful 20/20
```

### correlation

```{r}
correlation::correlation(d1, select = "ch_s",select2 = "bg_s")

correlation::correlation(d1, select = "bg_s",select2 = "anx")

correlation::correlation(d1, select = "ch_s",select2 = "anx")

```

```{r}
library(lme4)
```

### Check LMER Results

```{r}
library(patchwork)
mlmerCH <- lmer(
    anx ~
    #bg_s +
    ch_s +
    age_s  +
    male +
    ( 1 + ch_s | country), 
  data = d1)


sjPlot::tab_model(mlmerCH)


mlmerBG <- lmer(
    anx ~
    bg_s +
    ch_s +
    age_s  +
    male +
    ( 1 + bg_s | country), 
  data = d1)


sjPlot::tab_model(mlmerBG)
```

## General Estimating Equations

### IPW Anxiety \~ Belief


First check for imbalance using the cobolt package. 

```{r}
# CHECK BALANCE
# test
cobalt::bal.tab(bg_s ~ age_s  + male + country,
        data = d1, estimand = "ATE", m.threshold = .05)
```


Get inverse probability weights 

```{r}
w_out_bs <- weightit(bg_s ~ age_s  +ch_s +  male + country,
        data = d1, estimand = "ATE", method = "ebal", stabilize = TRUE)
w_out_bs

summary(w_out_bs)
sum(w_out_bs$weights)

cobalt::bal.tab(w_out_bs, m.threshold = .05, disp.v.ratio = TRUE)
```




```{r}
library("ipw")
d1ipwB <- ipw::ipwpoint(
  exposure = bg_s,
  family = "gaussian",
  numerator = ~ 1,
  denominator = ~  ch_s + age_s  + male + country,
  data = as.data.frame(d1)
)


summary(d1ipwB$ipw.weights)
sum(d1ipwB$ipw.weights >= 10)


d1pB <- d1 %>% 
  mutate(ipw = w_out_bs$weights) %>%
  filter(d1ipwB$ipw.weights < 10)


```

Model:

```{r}
mgeeB  <- geeglm(
  anx ~
    bg_s,# already weighted
   # ch_s +
   # age_s  +
   # male,
  data = d1pB,
  id = country,
  corstr = "exchangeable",
  weights = ipw
)
mgeeB

parameters::model_parameters(mgeeB) %>%
  print_html()

library(ggeffects)
p0BG <- plot(ggeffects::ggemmeans(mgeeB, terms = "bg_s [all]"), add.data = TRUE, dot.alpha = 0.1)    # 
p0BG 
```

### IPW Anxiety \~ Church

First we create Inverse Probability Weights

```{r}
library("ipw")

d1ipw <- ipw::ipwpoint(
  exposure = ch_s,
  family = "gaussian",
  numerator = ~ 1,
  denominator = ~  age_s  + male + country,
  data = as.data.frame(d1)
)


summary(d1ipw$ipw.weights)
sum(d1ipw$ipw.weights > 10)


d1p <- d1 %>% 
  mutate(ipw = d1ipw$ipw.weights) %>%
  filter(ipw < 10)
```

Model

```{r}
mgeeCH <- geeglm(
  anx ~
    ch_s,# + # already weighted
    #age_s  +
  #  male,
  data = d1p,
  id = country,
  weights = ipw
)


parameters::model_parameters(mgeeCH) %>%
  print_html()

library(ggeffects)
pmgeeCH <- plot(ggeffects::ggemmeans(mgeeCH, terms = "ch_s [all]"), add.data = TRUE, dot.alpha = 0.1)    # 
pmgeeCH
```

Model with with trimmed IPW (as recommended to avoid leverage from rare cases). Note, the result here is the same.

```{r, eval = FALSE}
# trim IPW to less than 10 
d1pf <- d1 %>% 
  mutate(ipw = d1ipw$ipw.weights) %>%
  filter(ipw < 10)

m0f <- geeglm(
  anx ~
    ch_s,# +
    #age_s  +
  #  male,
  data = d1pf,
  id = country,
  weights = ipw
)

parameters::model_parameters(m0f) %>%
  print_html()

library(ggeffects)
p0f <- plot(ggeffects::ggemmeans(m0f, terms = "ch_s [all]"), add.data = TRUE, dot.alpha = 0.1)    # 
p0f
```

## Results summary Anxiety \~ Belief

### Model

```{r}
m1 <- brm( 
  anx ~
    bg_s +
    ch_s +
    age_s  +
    male +
    (1 + bg_s | country),
  data = d1,
  family = cumulative(link = "logit"),
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = here::here("models", "m2o_real")
)

parameters::model_parameters(m1, test = "p_direction")
brms::ranef(m1)

parameters::parameters(
  m1,
  test = "pd",
  priors = FALSE, 
  effects = "all",
  drop = TRUE,
  group_level = FALSE,
  diagnostic = "Rhat") %>%
    mutate_if(is.numeric, ~ round(., 2)) %>%
    mutate_all(funs(str_replace(., "b_", ""))) %>%
    kable(booktabs = T, "latex", caption =  "Parameter estimates for model of Belief on Anxiety") %>%
    print()

```

Coefficient plots

Believe in God predicts more anxiety

```{r}
parF1 <- parameters::model_parameters(m1 ) 
parF1
plot(parF1,  sort = TRUE) +theme_lucid() #option -->
```

Variability in country intercepts, slope interactions not reliable.

India, however, is clearly an outlier.

```{r}
parR1<-parameters::model_parameters(m1,effects = "random" ) 
belief_random <- plot(parR1,  sort = TRUE) +theme_lucid()  + labs(title = "Country-level variability in anxiety intercepts are evident; country-level anxiety-on-belief co-variances
are not reliable: India is an outlier.") 
belief_random
```

No country level differences trending at the high end of the anxiety scale for slope/intercept covariance, but not at the low end of anxiety this pattern is reversed, leading to a canceling out ... such that overall the correlation isn't reliable [cor(Intercept,ch_s) 0.24 [-0.38, 0.77]. But worth investigating...and perhaps a more complex mixture model.

```{r}
plot(ggeffects::ggpredict(
  m1,
  terms = c("country[all]", "bg_s[minmax]"),
  type = "re",
  ci.lvl = 0.89
)) + scale_color_viridis_d() +  scale_y_continuous(limits = c(0,1)) + 
  theme_bw()
```

Clear relationship between lower distress and greater religious service attendance

```{r, cache = TRUE}
library(viridis)
p0<-brms::conditional_effects(m1, "bg_s", 
                              spaghetti = T,
                              ndraws = 500,
                              categorical = F,
                              prob = .89,
                              method = 'fitted')


belief_fixed <- plot(p0, plot = FALSE)[[1]]   +  xlab("belief (standardised)") + ylab ("anxiety (ordinal 1-5)") + labs(title = "Increasing belief is associated with increasing anxiety")
belief_fixed
```

### Checks:

```{r}
# YES
pp_check(m1)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(m1,
          type = "trace")
```

## Results summary: Anxiety \~ church

Does church attendance predict anxiety?

### Model

```{r echo}
glimpse(d1)
m2 <- brm(
    anx ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  data = d1,
  family = cumulative(link ="logit"),
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = here::here("models", "m1o_real")
)

parameters::parameters(
  m2,
  test = "pd",
  priors = FALSE, 
  effects = "all",
  drop = TRUE,
  group_level = FALSE,
  diagnostic = "Rhat") %>%
    mutate_if(is.numeric, ~ round(., 2)) %>%
    mutate_all(funs(str_replace(., "b_", ""))) %>%
    kable(booktabs = T, "latex", caption =  "Parameter estimates for model of Religious Service on Anxiety") %>%
    print()
```

### Results

Coefficient plots

More church attendance predicts less anxiety

```{r}
parc<-parameters::model_parameters(m2 ) 
plot(parc,  sort = TRUE) + theme_lucid() #option -->
```

Variability in country intercepts, slope interactions not reliable.

India, however, is clearly an outlier.

```{r}
parcR<-parameters::model_parameters(m2,effects = "random" ) 
church_random <- plot(parcR,  sort = TRUE) +theme_lucid() + labs(title = "Country-level variability in anxiety intercepts are evident; country-level anxiety-on-service co-variances
are not reliable: India is again an outlier.")

church_random
```

No country level differences trending at the high end of the anxiety scale for slope/intercept covariance, but not at the low end of anxiety this pattern is reversed, leading to a canceling out ... such that overall the correlation isn't reliable [cor(Intercept,ch_s) 0.24 [-0.38, 0.77]. But worth investigating...and perhaps a more complex mixture model.

```{r}
plot(ggeffects::ggpredict(
  m2,
  terms = c("country[all]", "ch_s[minmax]"),
  type = "re",
  ci.lvl = 0.89
)) + scale_color_viridis_d() + 
  theme_classic()
```

Clear relationship between lower distress and greater religious service attendance

```{r, cache = TRUE}
library(viridis)
p0b<-brms::conditional_effects(m2, "ch_s", 
                              spaghetti = T,
                              ndraws = 500,
                              categorical =T,
                              prob = .89,
                              method = 'fitted')


church_fixed <-plot(p0b, plot = FALSE)[[1]]  + xlab("religious service attendance (standardised)") + ylab ("anxiety (ordinal 1-5)") +
  labs(title = "Increasing religious service attendence is associated with lower anxiety")

church_fixed
```

## Results summary Belief \~ Anxiety

```{r}
m3<- brm(
  bg_s ~
    mo(anx)+
    ch_s +
    age_s  +
    male +
    (1 + mo(anx)| country),
  data = d1,
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = here::here("models", "m3o_real")
)

parameters::model_parameters(m3, test = "p_direction")
brms::ranef(m3)

parameters::parameters(
  m3,
  test = "pd",
  priors = FALSE, 
  effects = "all",
  drop = TRUE,
  group_level = FALSE,
  diagnostic = "Rhat") %>%
    mutate_if(is.numeric, ~ round(., 2)) %>%
    mutate_all(funs(str_replace(., "b_", ""))) %>%
    kable(booktabs = T, "latex", caption =  "Parameter estimates for model of Anxiety on Belief") %>%
    print()
```

<!-- ```{r} -->

<!-- this is no better -->

<!-- m3a<- brm( -->

<!--   bg_s ~ -->

<!--     anx_s+ -->

<!--     ch_s + -->

<!--     age_s  + -->

<!--     male + -->

<!--     (1 + anx_s | country), -->

<!--   data = d1, -->

<!--   seed = 1234, -->

<!--   warmup = 1000, -->

<!--   iter = 3000, -->

<!--   chains = 4, -->

<!--   file = here::here("models", "m3a") -->

<!-- ) -->

<!-- parameters::model_parameters(m3a, test = "p_direction") -->

<!-- brms::ranef(m3a) -->

<!-- summary(m3a) -->

<!-- hist(d1$bg_s) -->

<!-- # YES -->

<!-- pp_check(m3a) -->

<!-- ``` -->

Coefficient plots

Anxiety predicts belief

```{r}
parF3 <- parameters::model_parameters(m3 ) 
parF3
plot(parF3,  sort = TRUE) +theme_lucid() #option -->
```

Variability in country intercepts, slope interactions not reliable.

India, however, is clearly an outlier.

```{r}
parR3<-parameters::model_parameters(m3,effects = "random" ) 
anx_belief_random <- plot(parR3,  sort = TRUE) +theme_lucid()  + labs(title = "Country-level variabilty in belief intercepts are evident; country-level belief-on-anxiety co-variances
are not reliable.") 


anx_belief_random
```

No country level differences trending at the high end of the anxiety scale for slope/intercept covariance, but not at the low end of anxiety this pattern is reversed, leading to a canceling out ... such that overall the correlation isn't reliable [cor(Intercept,ch_s) 0.24 [-0.38, 0.77]. But worth investigating...and perhaps a more complex mixture model.

```{r}
plot(ggeffects::ggpredict(
  m3,
  terms = c("country[all]", "anx"),
  type = "re",
  ci.lvl = 0.89
)) + scale_color_viridis_d() +  scale_y_continuous(limits = c(0,1)) + 
  theme_bw()
```

```{r, cache = TRUE}
library(viridis)
p3<-brms::conditional_effects(m3, "anx", 
                              spaghetti = T,
                              ndraws = 500,
                              categorical = F,
                              prob = .89,
                              method = 'fitted')


belief_anxiety_random_fixed <- plot(p3, plot = FALSE)[[1]]   + xlab("Anxiety (monotonic ordinal 1-5)") + ylab ("Belief in God( standardised))") +
  labs(title = "Increasing anxiety is associated with increasing belief in God")

belief_anxiety_random_fixed
```

### Checks:

```{r}
# YES
pp_check(m3)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(m3,
          type = "trace")
```

## Results summary Church \~ Anxiety

```{r}
m4<- brm(
  ch_s ~
    mo(anx)+
    age_s  +
    male +
    (1 + mo(anx)| country),
  data = d1,
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = here::here("models", "m4o_real")
)

parameters::model_parameters(m4, test = "p_direction")
brms::ranef(m4)


parameters::parameters(
  m4,
  test = "pd",
  priors = FALSE, 
  effects = "all",
  drop = TRUE,
  group_level = FALSE,
  diagnostic = "Rhat") %>%
    mutate_if(is.numeric, ~ round(., 2)) %>%
    mutate_all(funs(str_replace(., "b_", ""))) %>%
    kable(booktabs = T, "latex", caption =  "Parameter estimates for model of Anxiety on Religious Service") %>%
    print()
```

<!-- ```{r} -->

<!-- this is no better -->

<!-- m3a<- brm( -->

<!--   bg_s ~ -->

<!--     anx_s+ -->

<!--     ch_s + -->

<!--     age_s  + -->

<!--     male + -->

<!--     (1 + anx_s | country), -->

<!--   data = d1, -->

<!--   seed = 1234, -->

<!--   warmup = 1000, -->

<!--   iter = 3000, -->

<!--   chains = 4, -->

<!--   file = here::here("models", "m3a") -->

<!-- ) -->

<!-- parameters::model_parameters(m3a, test = "p_direction") -->

<!-- brms::ranef(m3a) -->

<!-- summary(m3a) -->

<!-- hist(d1$bg_s) -->

<!-- # YES -->

<!-- pp_check(m3a) -->

<!-- ``` -->

Coefficient plots

Anxiety predicts belief

```{r}
parF4 <- parameters::model_parameters(m4 ) 
parF4
plot(parF4,  sort = TRUE) +theme_lucid() #option -->
```

Variability in country intercepts, slope interactions not reliable.

India, however, is clearly an outlier.

```{r}
par4<-parameters::model_parameters(m4,effects = "random" ) 
anx_church_random <- plot(par4,  sort = TRUE) + theme_lucid()  + labs(title = "Country-level variabilty in religious service intercepts are evident; country-level service-on-anxiety co-variances
are not reliable.") 


anx_church_random
```

```{r}
plot(ggeffects::ggpredict(
  m4,
  terms = c("country[all]", "anx"),
  type = "re",
  ci.lvl = 0.89
)) + scale_color_viridis_d() +  scale_y_continuous(limits = c(0,1)) + 
  theme_bw()
```

```{r, cache = TRUE}
library(viridis)
p4<-brms::conditional_effects(m4, "anx", 
                              spaghetti = T,
                              ndraws = 500,
                              categorical = F,
                              prob = .89,
                              method = 'fitted')


church_anxiety_random_fixed <- plot(p4, plot = FALSE)[[1]]   + xlab("Anxiety (monotonic ordinal 1-5)") + ylab ("Religious Service(standardised))") +
  labs(title = "Increasing anxiety is associated with decreasing church attendance.")

church_anxiety_random_fixed
```

### Checks:

```{r}
# YES
pp_check(m4)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(m4,
          type = "trace")
```

## Combined plot

```{r}
library(patchwork)

(belief_fixed +  belief_random)/(church_fixed+ church_random  ) / 
(belief_anxiety_random_fixed + anx_belief_random) / (church_anxiety_random_fixed + anx_church_random) +
  plot_annotation(tag_levels = "a")# + plot_layout(guides = "collect")

# coef_graph 15 x 25
```

### Checks:

```{r}
# YES
pp_check(m2)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(m2,
          type = "trace")
```

### Overall summary

Belief in God predicts anxiety. This is consistent with theories that anxiety leads to greater demand for belif in God. However, this question awaits future research.

Church attendance positively predicts lower anxiety.

### Group level-predictions

There is substantial variation in country-level intercepts for anxiety. And substantial cultural level variation in religious practice and belief. All this needs to be explained. India is an outlier.

## Simulation

```{r}
set.seed(123)
n <- 1000
# distressing events (unmeasured)
U <- rnorm( n ) 
# religious service attendance increases with distress
C <- rnorm( n, U ) 
# anxiety caused by distress experience and
# buffered by religious service
Y <- rnorm( n , U - C )  

# belief increases with service, anxiety,
# and experience
B <- rnorm( n , Y + C + U )


# simulate data
simdat <- data.frame(
  Belief = B, # belief
  ReligiousService = C, # religious service
  U = U, # distressing events (unmeasured)
  Anxiety = Y  # outcome
  )

# summarise results
summary(
  mod1 <- lm(Anxiety ~ Belief + ReligiousService, data = simdat)
)

# summarise results
summary(
  mod1b <- lm(Anxiety ~ ReligiousService, data = simdat)
)

summary(
  mod2 <- lm(Belief  ~ Anxiety + ReligiousService, data = simdat)
)

summary(
  mod3 <- lm(ReligiousService  ~ Anxiety, data = simdat)
)

belief_on_anxiety_sim <- plot( ggeffects::ggpredict(mod1, terms = c("Belief")), add.data = TRUE, dot.alpha =.5 ) + labs(title = "Simulation recovers positive relationship between belief on anxiety") + scale_y_continuous(limits = c(-7,7))+ scale_x_continuous(limits = c(-10,10))

service_on_anxiety_sim <- plot( ggeffects::ggpredict(mod1b, terms = c("ReligiousService")), add.data = TRUE, dot.alpha =.5 ) + labs(title = "Simulation recovers negative relationship between religious service on anxiety")+ scale_y_continuous(limits = c(-7,7))+ scale_y_continuous(limits = c(-7,7))+ scale_x_continuous(limits = c(-10,10))
service_on_anxiety_sim

service_on_anxiety_sim <- plot( ggeffects::ggpredict(mod1, terms = c("ReligiousService")), add.data = TRUE, dot.alpha =.5 ) + labs(title = "Simulation recovers negative relationship between religious service on anxiety")+ scale_y_continuous(limits = c(-7,7))+ scale_x_continuous(limits = c(-10,10))
service_on_anxiety_sim

anxiety_on_belief_sim <- plot( ggeffects::ggpredict(mod2, terms = c("Anxiety")), add.data = TRUE, dot.alpha =.5 ) + labs(title = "Simulation recovers positive relationship between anxiety on belief")+ scale_y_continuous(limits = c(-7,7))+ scale_x_continuous(limits = c(-10,10))
anxiety_on_belief_sim


anxiety_on_church_sim <- plot( ggeffects::ggpredict(mod3, terms = c("Anxiety")), add.data = TRUE, dot.alpha =.5 ) + labs(title = "Simulation recovers negative relationship between anxiety on religious service")+ scale_y_continuous(limits = c(-7,7))
anxiety_on_church_sim

library(patchwork)

(belief_on_anxiety_sim +  service_on_anxiety_sim)/ (anxiety_on_belief_sim + anxiety_on_church_sim)

# sim_graph 15 x 15

```

We can convince ourselves of this result by replicating it many times

```{r}
sim_fun = function() {
n <- 1000
U <- rnorm( n ) # distressing events (unmeasured)
C <- rnorm( n, U ) # religious service attendance, increase with distress
Y <- rnorm( n , U - C ) # measured distress caused by distress, reduced by church attendance. 
B <- rnorm( n , Y + C + U )# belief increase with service + distressing events + anxiety

# simulate data
simdat <- data.frame(
  Belief = B, # belief
  ReligiousService = C, # religious service
  U = U, # distressing events (unmeasured)
  Anxiety = Y  # outcome
  )

  sim_s <- lm(Anxiety ~ Belief + ReligiousService, data = simdat)
  sim_s
}

# Replication 1000xs
r_lm = replicate(1000, sim_fun(), simplify = FALSE )

# extract simulations
tab_sim<-purrr::map_dfr(r_lm, broom::tidy)

# extract belief coefficients
mout<-tab_sim %>%
  dplyr::filter(term =="Belief")%>%
  dplyr::mutate_if(is.numeric, round, 5)

# calculate proportion of estimates greater than 0
# all positive
sum(mout$estimate > 0) / length(mout$estimate)

# proportion of belief coefficient p.values < .001
sum(mout$p.value <.001) / length(mout$p.value)

# extract religious service coefficients
tout<-tab_sim %>%
  dplyr::filter(term =="ReligiousService")%>%
  dplyr::mutate_if(is.numeric, round, 5)

# calculate proportion of estimates less than 0
# all negative
sum(tout$estimate < 0) / length(tout$estimate)

# proportion of service coefficient p.values < .001
sum(tout$p.value <.001) / length(tout$p.value)
```

˝#\# Simulation tables

```{r}
parameters::parameters(
  mod1,
  test = "pd",
  priors = FALSE, 
  effects = "all",
  drop = TRUE,
  group_level = FALSE,
  diagnostic = "Rhat") %>%
    mutate_if(is.numeric, ~ round(., 2)) %>%
    mutate_all(funs(str_replace(., "b_", ""))) %>%
    kable(booktabs = T, "latex", caption =  "Simulation reveals how church attendance and belief can deviate where distress increases religious service attendance and belief in God") %>%
    print()




parameters::parameters(
  mod2,
  test = "pd",
  priors = FALSE, 
  effects = "all",
  drop = TRUE,
  group_level = FALSE,
  diagnostic = "Rhat") %>%
    mutate_if(is.numeric, ~ round(., 2)) %>%
    mutate_all(funs(str_replace(., "b_", ""))) %>%
    kable(booktabs = T, "latex", caption =  "Same simulation tracks anxiety as cause of religious belief") %>%
    print()



parameters::parameters(
  mod3,
  test = "pd",
  priors = FALSE, 
  effects = "all",
  drop = TRUE,
  group_level = FALSE,
  diagnostic = "Rhat") %>%
    mutate_if(is.numeric, ~ round(., 2)) %>%
    mutate_all(funs(str_replace(., "b_", ""))) %>%
    kable(booktabs = T, "latex", caption =  "Same simulation tracks anxiety as cause of decling religious service") %>%
    print()
```

## DETAILS OF ANLAYSIS FOR REPLICATION

## Workflow and analysis

First, we inspect the data. A challenge is that many columns data have been transformed from their raw form into a number between 0 and 1. Later we'll see that these transformations render the modelling less reliable than if the data were retained.

So for the next iteration, we'll need the data as they were recorded. Specially we'll focus on the variables such as

> How often do you have negative feelings such as blue mood, despair, anxiety, depression

We'll investigate church frequency and belief in God as predictors of this dimension of well-being.

```{r, echo = FALSE, include = FALSE}
#inspect data frame
str(d) # need to create factors, where factors are needed.
```

```{r, Include = FALSE}
hist(d$rel_1)  # yikes -- factors (church freq was made into a number :(  loss of signal 
hist(d$rel_1)  # yikes -- factors prayer freq was made into a number  :(  loss of signal
```

```{r, include = FALSE}
table(d$rel_3,useNA = "ifany") # This is absolutely not good. 
```

```{r include = FALSE}
#  need to recode factors -- NAs should be NAs, otherwise, we should describe them as missingness, so will avoid these variables
table(d$ethnicity,  useNA = "ifany") # need recode NA as "not identified"
table(d$denomination, useNA = "ifany") # need recode NA as "no denomination" 
# fix
d$denomination[is.na(d$denomination)] <- "not_reported"
d$ethnicity[is.na(d$ethnicity)] <- "not_reported"
#d$wb_soc_3[is.na(d$wb_soc_3)] <- "not_reported" # Sat with sex
```

```{r, include = FALSE}
# what are the numbers here? 
table(d$attention_check, useNA = "ifany")
d$wb_phys_mean
```

## Missingness

Next we need to examine patterns of missing-ness, which might spoil inference.

```{r cache = TRUE}
library("naniar")
vis_miss(df) # substantial pattern of missingness in a few variables, 
gg_miss_upset(df)
```

There is little missingness so we will use only complete cases. Note that it would be better to have a method for handling the uncertainty of missingness. Missing data should be handled by some probabilistic imputation strategy. However, because there are many larger problems about measurement error, sampling, and theory, lets set these to questions to the side and work with the complete dataset

```{r, include = FALSE}
# get columns for different indicators 
rel <- get_rel_vars(df)
wbgen <- get_wb_gen(df)
wbphys <- get_wb_phys(df)
wbpsych <- get_wb_psych(df)
wbsoc <- get_wb_soc(df)

```

Next some exploration Graphs. Inspecting the sample responses on religion.

```{r, cache = TRUE, echo = FALSE}
head(rel)
r1 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_CHURCHFREQ,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Church Frequency") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r1

r2 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_PRAYERFREQ,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Prayer Frequency") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r2

r3 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_EXTENTBELIEVEGOD,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Extent Believe in God") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))

r3

r4 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_EXTENTBELIEVEAFTERLIFE,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Extent Believe in Afterlife") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r4

r5 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_EXTENTSPIRITUAL,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Extent Spiritual") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r5

r6 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_IMPORTANCERELIGIOUSLIFE,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Importance of Religious Life") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r6


r7 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_IMPORTANCEBELIEVEGOD,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  ggtitle("Importance Believe in God") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r7
```

```{r, cache = TRUE, include = FALSE}
library("patchwork")
(
  r1 + r2  +  r3
)/  (r4  + r5) / (r6 +  r7)   +  plot_annotation(tag_levels = 'A') + plot_layout(guides = "collect")
```

Substantial between country variation evident. India = very high

Let's look at the anxiety indicator: India is much lower: .

```{r}
wbpsych
wb1 <- wbpsych %>%
  ggplot(aes(
    x = country,
    y = 6 - wb_psychANXIETY, # reverse code
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  ggtitle("Importance Believe in God") +
  ylab("") + 
  theme(axis.text.x = element_text(angle = 30))
wb1

```

We're interested in meaning of life as a causal mediator of anxiety

```{r}
wb2 <- wbpsych %>%
  ggplot(aes(
    x = country,
    y = wb_psychMEANING,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  ggtitle("Importance Believe in God") +
  ylab("") + 
  theme(axis.text.x = element_text(angle = 30))
wb2
```

India again very high, and France is very low. Can we really assume measurement invariance across these countries? Are people so really different? As with any model, we condition on assumptions, however at another iteration of this study, however for now we will assume measurement invariance.

Next, a quick run of correlations. Note that we need the to model the country level dependencies in any correlation matrix, given strong cultural differences

<!-- Religion correlations -->

<!-- ```{r, cache = TRUE} -->

<!-- rel %>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   plot() + theme_blackboard() -->

<!-- ``` -->

<!-- General well-being correlations -->

<!-- ```{r cache = TRUE} -->

<!-- wbgen %>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   plot() + theme_blackboard() -->

<!-- ``` -->

<!-- Physical well-being correlations -->

<!-- ```{r} -->

<!-- wbphys %>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   summary() -->

<!-- wbphys %>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   plot() + theme_blackboard() -->

<!-- ``` -->

<!-- Psychological well-being correlations -->

<!-- ```{r} -->

<!-- wbpsych %>% -->

<!--   select(-wb_psychMEANING)%>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   summary() -->

<!-- wbpsych %>% -->

<!--   select(-wb_psychMEANING)%>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   plot()  + theme_abyss() -->

<!-- ``` -->

#### The statistical model

A bayesian workflow should include prior predictive checks and the use of informative priors (McElreath 2020).

For this initial analysis I am going to use the weakly informative priors that BRMS uses; my experience is that large data sets are resistant to choice of priors. However it is a mistake to trust this experience. For now, though, we must keep to time, and timing is everything.

Additionally, the data have been manipulated in advance of the study to be scaled to a range between 0 and 1. This is a very bad idea. It would be much better to thinking of church attendance frequency as a monotonic effect. I will do that analysis at the next round, if the data are made available in their original form.

Here is the model for church attendance and anxiety

Wrangle data

```{r}
# get data into shape
d1 <- df %>%
  dplyr::filter(
    !is.na(wb_psychANXIETY),
    !is.na(age),
    !is.na(rel_CHURCHFREQ),
    !is.na(wb_psychMEANING),
    !is.na(male),
    !is.na(rel_EXTENTBELIEVEGOD),
  ) %>%
  dplyr::mutate(
    anx = as.numeric(6- wb_psychANXIETY), # recode
    anx_s = scale(wb_psychANXIETY),
    #put outcome in ST units (see McElreath 2021)  # not necessary
    age_s = scale(age),
    ch = rel_CHURCHFREQ,
    mn  = wb_psychMEANING,
    bg =  rel_EXTENTBELIEVEGOD,
    ch_s = scale(rel_CHURCHFREQ),
    mn_s = scale(wb_psychMEANING),
    bg_s = scale(rel_EXTENTBELIEVEGOD)
  ) %>%
  dplyr::select(anx,
                ch,
                mn,
                bg,
                anx_s,
                age_s,
                ch_s,
                mn_s,
                male2,
                country,
                male,
                bg_s,
                wb_psychANXIETY)

## degroup variables for within and between analysis
## https://cran.r-project.org/web/packages/parameters/vignettes/demean.html
d1 <-
  cbind(d1,
        demean(d1, select = c("anx", "ch", "bg"), group = "country"))
```

We might estimate that effects differ within and between groups, but ignoring within and between country heterogeneity and simply pooling effects at the country level

```{r}
m1 <- brm(
  anx_s ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  sample_prior = TRUE,
  data = d1,
  family = "gaussian",
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m1_real_data"
)
parameters::model_parameters(m1, test = "p_direction")
parameters::random_parameters(m1)
```

Greater church attendance is associate with greater anxiety. There is substantial within-group variance, with a low correlation of country-level slope by intercept variances.

```{r cache = TRUE}
p1 <- brms::conditional_effects(
  m1,
  "ch_s",
  spaghetti = T,
  nsamples = 300,
  prob = .89,
  method = 'fitted'
)

plot(p1, plot = FALSE)[[1]] + 
  scale_y_continuous(limits = c(-1, 1))  + 
  xlab("church sd units") + 
  ylab("anxiety in sd units") +
  labs(title = "Predicted effect of ch_s")
```

Before racing ahead, lets do some posterior predictive checks on the model

The trace plots look good.

```{r cache = TRUE}
brms::mcmc_plot(m1,
          type = "trace")
```

However the posterior predictive check reveals that we should work with the original untransformed values of the outcome variable data.

```{r cache = TRUE}
# we see the ordinal qualities of our dataset here
pp_check(m1) # here we pick up the categorical qualities of the distribution
```

For now, we press ahead. Let's graph the location effects

```{r cache = TRUE}
mcmc_plot(m1,
          type = "intervals",
          prob_outer = 0.89)
```

Note: there is huge country-level variability in the MCMC solutions and uncertainty in the correlations between country level intercepts in slopes. How should we interpret these results:

-   Countries have different levels of anxiety;

-   There is variability in the church-level effects on anxiety by country, but this is unreliably correlated with the slope prediction of church-attendance

We'd want to check the priors in this model, and probably use a more informative prior for the correlation of country anxiety and church attendance.

These are our model priors:

```{r}
prior_summary(m1)
```

However we cannot sample from the models priors because some are improper.

```{r}
library(coda)
samples1 <- brms::prior_samples(m1, "b_ch_s")
```

To see this, run the following and note the warning.

```{r eval = FALSE}
m1_prior <- brm(
  anx_s ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  data = d1,
  family = "gaussian",
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m1_prior",
  sample_prior = "only"
)
```

```{r eval= FALSE}
prior_summary(m1)
```

A key problem is the use of uninformative priors

```{r eval = FALSE}
bayestestR::describe_prior(m1)
```

Let's try with an informative prior

```{r cache = TRUE}
m1_prior <- brm(
  anx_s ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  data = d1,
  family = "gaussian",
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m1_prior",
  set_prior("normal(0,.5)", class = "b"),
  sample_prior = "only")
bayestestR::describe_prior(m1_prior)
```

This prior allows positive and negative relationships from -6 to + 4 standard deviations, so would not be informative.

or we can simulate and see that our prior is scattered across five standard deviations of anxiety, and we can see our prior is telling us that anything can happen .

```{r cache = TRUE}
p <- brms::conditional_effects(
  m1_prior,
  "ch_s",
  spaghetti = T,
  nsamples = 1000,
  prob = .89,
  method = 'fitted'
)
plot(p, plot = FALSE)[[1]] + scale_y_continuous(limits = c(-5, 5))  + xlab("church sd units") + ylab ("anxiety in sd units") +
  labs(title = "Expected values for our attempted informative prior reveals remains too flat")
```

Even this prior is diffuse.

We'll return to our priors and sampling distribution at the next iteration of this analysis. Let's set this to the side for now, and focus on the country level variability, looking first at the expectation plots.

#### The group level effects of country

There is lots of variability at the country level intercepts for anxiety. We can see that India is over .5 standard deviations less anxious than the average culture level anxiety. By contrast, Japan, Israel, and France are over .3 standard deviations more anxious than average. There looks to be perhaps some covariance between the country intercepts and slopes... maybe though all estimates crosses zero. We'd either want to use stronger priors or collect data from more countries than are in this sample.

```{r cache = TRUE}
library(see) 
library(parameters) 
par <- parameters::model_parameters(m1, effects = "random")
plot(par,  sort = TRUE) + theme_lucid() #option -->
```

```{r cache = TRUE}
plot(ggeffects::ggpredict(
  m1,
  terms = c("country[all]", "ch_s[minmax]"),
  type = "re",
  ci.lvl = 0.89
))  +  scale_fill_brewer(palette = "Set2") +
  theme_classic()
```

<!-- Let's delving into this question of country level effects by asking whether people who are *relatively* more church attending within their countries tending to have more anxiety.  -->

<!-- - within_church centering = relative church attendance within a country. -->

<!-- - between_church centering = country level differences in church attendance. -->

<!-- ## Within and between -->

<!-- Here's a model that includes within and between country centered variables. See: -->

<!-- https://easystats.github.io/parameters/reference/demean.html -->

<!-- The model. -->

<!-- wb_psychANXIETY -->

<!-- ```{r} -->

<!-- m1a <- brm( -->

<!--   anx_s ~ age_s  + male + ch_within +  ch_between + (1 + ch_within | country), -->

<!--   data = d1, -->

<!--   family = "gaussian", -->

<!--   seed = 1234, -->

<!--   warmup = 1000, -->

<!--   iter = 3000, -->

<!--   chains = 4, -->

<!--   file = "m1_a.rds_real" -->

<!-- ) -->

<!-- parameters::model_parameters(m1a, -->

<!--                              test = "p_direction") -->

<!-- parameters::random_parameters(m1a) -->

<!-- ``` -->

<!-- We find a positive relation of "ch_within" to anxiety.  -->

<!-- ```{r cache = TRUE} -->

<!-- p <- brms::conditional_effects( -->

<!--   m1a, -->

<!--   "ch_within", -->

<!--   spaghetti = T, -->

<!--   nsamples = 3000, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- plot(p, plot = FALSE)[[1]] +  -->

<!--   scale_y_continuous(limits = c(-1, 1)) +  -->

<!--   xlab("church_within") +  -->

<!--   ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of ch_within") -->

<!-- ``` -->

<!-- There is, are somewhat reliable between-country difference, however the effect becomes uncertain at the high end of between-country differences: -->

<!-- ```{r cache = TRUE} -->

<!-- p <- brms::conditional_effects( -->

<!--   m1a, -->

<!--   "ch_between", -->

<!--   spaghetti = T, -->

<!--   nsamples = 3000, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- plot(p, plot = FALSE)[[1]] + scale_y_continuous(limits = c(-1, 1))  + xlab("church_between") + ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of ch_between") -->

<!-- ``` -->

<!-- Before considering this, let's run some model checks on our workflow.  -->

<!-- Trace plots for the model look OK -->

<!-- ```{r} -->

<!--  mcmc_plot(m1a, -->

<!--           type = "trace") -->

<!-- ``` -->

<!-- No surprise, there is the same problem with the sampling distribution. -->

<!-- ```{r} -->

<!-- # we see the ordinal qualities of our dataset here -->

<!-- pp_check(m1a) -->

<!-- ``` -->

<!-- Next the interval plots: -->

<!-- ```{r} -->

<!-- mcmc_plot(m1a, -->

<!--           type = "intervals", -->

<!--           prob_outer = 0.89) -->

<!-- ``` -->

### Ordinal regression: church

```{r}
m1o <- brm(
  wb_psychANXIETY ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  data = d1,
  family = cumulative(link ="logit"),
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m1o_real"
)
parameters::model_parameters(m1o, test = "p_direction")
parameters::random_parameters(m1o, component = "conditional")
summary(m1o)
```

Focussing on country level variances, we find the slope of the country intercept not reliably correlated with the church attendance slope.

```{r}
summary(m1o)
```

This resolves the problem

```{r}
# YES
pp_check(m1o)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(m1o,
          type = "trace")
```

Model summary

```{r}
parameters::model_parameters(m1o)
```

Plot model, here we see that the effects are driven at the high-end of the anxiety scale. This evidence is consistent with religion as an attractor for people who have high anxiety (see Bulbulia and Sibley 2012, Faith after the Quake)

```{r, cache = TRUE}
library(viridis)
p0b<-brms::conditional_effects(m1o, "ch_s", 
                              spaghetti = T,
                              nsamples = 200,
                              categorical = T,
                              prob = .89,
                              method = 'fitted')


plot(p0b, plot = FALSE)[[1]]   + xlab("ch_s") + ylab ("anxiety 1-5") +
  labs(title = "Predicted effects of ch_s")
# + scale_y_continuous(limits= c(1,5))# +  scale_color_viridis(discrete=TRUE) 
```

<!-- Another plot method -->

<!-- ```{r, cache = TRUE} -->

<!-- library(viridis) -->

<!-- p0b1<-brms::conditional_effects(m1o, "ch_s",  -->

<!--                               spaghetti = T, -->

<!--                               nsamples = 200, -->

<!--                              categorical = F, -->

<!--                               prob = .89, -->

<!--                               method = 'fitted') -->

<!-- plot(p0b1, plot = FALSE)[[1]]   + xlab("ch_s") + ylab ("anxiety 1-5") + -->

<!--   labs(title = "Predicted effects of ch_s")+ scale_y_continuous(limits= c(1,5))# +  scale_color_viridis(discrete=TRUE)  -->

<!-- ``` -->

<!-- ### with demeaning -->

<!-- ```{r} -->

<!-- m1a_o <- brm( -->

<!--   wb_psychANXIETY ~  -->

<!--     age_s  +  -->

<!--     male +  -->

<!--     ch_within +   -->

<!--     ch_between +  -->

<!--     (1 + ch_within|country),   -->

<!--   data = d1, -->

<!--   family = cumulative(link ="logit"), -->

<!--   seed = 1234, -->

<!--   warmup = 1000, -->

<!--   iter = 2000, -->

<!--   chains = 4, -->

<!--   file = "m1a_o_real") -->

<!-- ``` -->

<!-- This resolves the problem -->

<!-- ```{r} -->

<!-- # YES -->

<!-- pp_check(m1a_o) -->

<!-- ``` -->

<!-- Trace plots: -->

<!-- ```{r, cache = TRUE} -->

<!-- mcmc_plot(m1a_o, -->

<!--           type = "trace") -->

<!-- ``` -->

<!-- Model summary -->

<!-- ```{r} -->

<!-- parameters::model_parameters(m1a_o) -->

<!-- ``` -->

<!-- We  find a correlation of within person anxiety intercept by country and within person slope of church attentnce on anxiety, but the correlation is attenuated.  -->

<!-- ```{r, cache = TRUE} -->

<!-- library(viridis) -->

<!-- pch_w <- brms::conditional_effects( -->

<!--   m1a_o, -->

<!--   "ch_within", -->

<!--   spaghetti = T, -->

<!--   nsamples = 200, -->

<!--   categorical = TRUE, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- ppch_w <- -->

<!--   plot(pch_w, plot = FALSE)[[1]]    + ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of Church_within") # +  scale_color_viridis(discrete=TRUE) -->

<!-- ppch_w -->

<!-- ``` -->

<!-- ```{r} -->

<!-- par <- parameters::model_parameters(m1a_o, effects = "random") -->

<!-- plot(par,  sort = TRUE) + theme_lucid() #option -->

<!-- ``` -->

<!-- BETWEEN: Yes, and at the highest levels of anxiety.  -->

<!-- ```{r cache = TRUE} -->

<!-- pch_b <- brms::conditional_effects( -->

<!--   m1a_o, -->

<!--   "ch_between", -->

<!--   spaghetti = T, -->

<!--   nsamples = 200, -->

<!--   prob = .89, -->

<!--   categorical = TRUE, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- ppch_b <- -->

<!--   plot(p, plot = FALSE)[[1]]   + -->

<!--   xlab("ch_between") + ylab ("anxiety: 1-5") + -->

<!--   labs(title = "Predicted effects of Church_between") -->

<!-- ppch_b -->

<!-- ``` -->

<!-- ### Different plot method -->

<!-- Summing over the categories: -->

<!-- ```{r, cache = TRUE} -->

<!-- library(viridis) -->

<!-- p0a<-brms::conditional_effects(m1a_o, "ch_within",  -->

<!--                               spaghetti = T, -->

<!--                               nsamples = 200, -->

<!--                              # categorical = TRUE, -->

<!--                               prob = .89, -->

<!--                               method = 'fitted') -->

<!-- plot(p0a, plot = FALSE)[[1]]   + xlab("bg_within") + ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of bg_within")  + scale_y_continuous(limits = c(1,5))# +  scale_color_viridis(discrete=TRUE)  -->

<!-- ``` -->

<!-- ```{r cache = TRUE} -->

<!-- ps<-brms::conditional_effects(m1a_o, "ch_between",  -->

<!--                               spaghetti = T, -->

<!--                               nsamples = 200, -->

<!--                               prob = .89, -->

<!--                              # categorical = TRUE, -->

<!--                               method = 'fitted') -->

<!-- plot(ps, plot = FALSE)[[1]]   + xlab("bg_between") + ylab ("anxiety: 1-5") +  -->

<!--   labs(title = "Predicted effects of bg_between") + scale_y_continuous(limits = c(1,5)) -->

<!-- ``` -->

### Results: church

Which we interpret as follows:

-   Countries have different levels of anxiety;

-   Within a country, those whose who participate more frequently in church can be expected to have higher anxiety as those who do not participate as frequently in church.

-   Between_country predictions trend in the opposite direction, though not reliably at the high end of the anxiety spectrum this indicates.

Let's look at the country-level variances more closely

```{r}
par<-parameters::model_parameters(m1o,effects = "random" ) 
plot(par,  sort = TRUE) +theme_lucid() #option -->
```

Countries who differ in their average levels of church attendance differ present differences in their expected anxiety levels, with an unreliable trend in the opposite direction.

## Belief in God

Lets consider the non-trivial theory that belief in God (bg) affects psychological anxiety (wb) by affording a sense of meaning in life.

We begin by drawing the dag.

And again, we face a collider bias. Our causal model shows us that if we were to include our meaning-making indicator in our statistical we will compromise inference!

```{r}
ggdag::ggdag_collider(dg1,
                      from = "church",
                      to = "wb",
                      controlling_for(c("male", "support", "country", "age")))
```

We find weak effect for belief in God. No correlation of intercept and slope but India is an outlier.

```{r cache = TRUE}
p <- brms::conditional_effects(
  m2,
  "bg_s",
  spaghetti = T,
  nsamples = 300,
  prob = .89,
  method = 'fitted')

plot(p, plot = FALSE)[[1]] +
  scale_y_continuous(limits = c(-1, 1))  + 
  xlab("bg_s") + 
  ylab ("anxiety in sd units") +
  labs(title = "Predicted effects of bg_s")

```

How did the model mix? Trace plots look OK

```{r}
 mcmc_plot(m2,
          type = "trace")
```

Again, unsurprisingly we find a same problem with the sampling distribution.

```{r}
# we see the ordinal qualities of our dataset here
pp_check(m2)
```

Note: we'd want to check the priors in this model, and use more informative priors. TBA...

Next the interval plots:

```{r}
mcmc_plot(m2,
          type = "intervals",
          prob_outer = 0.89)
```

Summary:

-   Small individual-level prediction of belief in God on reduced anxiety (though recall our warning about demand characteristics)

## India is an outlier

```{r}
par<-parameters::model_parameters(m2,effects = "random" ) 
plot(par,  sort = TRUE) +theme_lucid()
```

<!-- ```{r cache = TRUE} -->

<!-- p <- brms::conditional_effects( -->

<!--   m2, -->

<!--   "bg_s", -->

<!--   spaghetti = T, -->

<!--   nsamples = 300, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- plot(p, plot = FALSE)[[1]] + scale_y_continuous(limits = c(-1, 1))  + xlab("bg_s") + ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of bg_s") -->

<!-- ``` -->

<!-- There country-level variability is all in anxiety, but not in the effect of belief in God. -->

<!-- ```{r cache = TRUE} -->

<!-- plot(ggeffects::ggpredict( -->

<!--   m2, -->

<!--   terms = c("country[all]", "bs_s[minmax]"), -->

<!--   type = "re", -->

<!--   ci.lvl = 0.89 -->

<!-- ))  + -->

<!--   scale_fill_brewer(palette = "Set2") + labs(title = "Predicted effects of bs_s on anxiety") + -->

<!--   scale_y_continuous(limits = c(-1, 1)) -->

<!-- ``` -->

<!-- Next we turn to the "within country relative differences" model for belief in God on anxiety. -->

### Statistical model: belief (Ordinal)

```{r}
m2o <- brm(
  wb_psychANXIETY ~ bg_s +
    age_s  +
    male +
    (1 + bg_s | country),
  data = d1,
  family = cumulative(link = "logit"),
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m2o_real.rds"
)
parameters::model_parameters(m2o, test = "p_direction")
parameters::random_parameters(m2o)
```

This resolves the problem

```{r}
# YES
pp_check(m2o)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(m2o,
          type = "trace")
```

Model summary

```{r}
parameters::model_parameters(m2o)
```

Plot model: nothing

```{r, cache = TRUE}
library(viridis)
p0 <- brms::conditional_effects(
  m2o,
  "bg_s",
  spaghetti = T,
  categorical = TRUE,
  nsamples = 200,
  prob = .89,
  method = 'posterior_epred'
)


plot(p0, 
  #  point_args = list(width = .3) ,
  #  points = TRUE,
     plot = FALSE)[[1]]   + xlab("bg") + ylab ("anxiety 1-5") +
  labs(title = "Predicted effects of bg") # +  scale_color_viridis(discrete=TRUE) 
```

<!-- ###  With demeaning NOT NEEDED-->

<!-- ```{r} -->

<!-- m2_o <- brm( -->

<!--   wb_psychANXIETY ~ age_s  + male + bg_within +  bg_between + (1 + ch_within|country),   -->

<!--   data = d1, -->

<!--   family = cumulative(link ="logit"), -->

<!--   seed = 1234, -->

<!--   warmup = 1000, -->

<!--   iter = 3000, -->

<!--   chains = 4, -->

<!--   file = "m2_o_real.rds") -->

<!-- ``` -->

<!-- This resolves the problem -->

<!-- ```{r} -->

<!-- # YES -->

<!-- pp_check(m2_o) -->

<!-- ``` -->

<!-- Trace plots: -->

<!-- ```{r, cache = TRUE} -->

<!-- mcmc_plot(m2_o, -->

<!--           type = "trace") -->

<!-- ``` -->

<!-- Model summary -->

<!-- ```{r} -->

<!-- parameters::model_parameters(m2_o) -->

<!-- ``` -->

<!-- Within: NOTHING -->

<!-- ```{r, cache = TRUE} -->

<!-- library(viridis) -->

<!-- p0bg <- brms::conditional_effects( -->

<!--   m2_o, -->

<!--   "bg_within", -->

<!--   spaghetti = T, -->

<!--   nsamples = 200, -->

<!--   categorical = TRUE, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- ppbg_w<- plot(p0bg, plot = FALSE)[[1]]   + xlab("bg_within") + ylab ("anxiety 1-5") + -->

<!--   labs(title = "Predicted effects of BeliefGod_within") # +  scale_color_viridis(discrete=TRUE)  -->

<!-- ppbg_w -->

<!-- ``` -->

<!-- BETWEEN: Yes, and at the highest levels of anxiety.  -->

<!-- ```{r cache = TRUE} -->

<!-- pbg <- brms::conditional_effects( -->

<!--   m2_o, -->

<!--   "bg_between", -->

<!--   spaghetti = T, -->

<!--   nsamples = 200, -->

<!--   prob = .89, -->

<!--   categorical = TRUE, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- ppbg_b<- plot(pbg, plot = FALSE)[[1]]   + xlab("bg_between") + ylab ("anxiety: 1-5") + -->

<!--   labs(title = "Predicted effects of BeliefGod_between") -->

<!-- ppbg_b -->

<!-- ``` -->

<!-- ## Summary graph -->

<!-- ```{r} -->

<!-- library(patchwork) -->

<!-- ppch_w +  ppbg_w  + ppch_b + ppbg_b + plot_annotation("What is the relationship between belief church and belief on anxiety?", subtitle = "People with greater belief in God have less anxiety accross countries.", tag_levels = "a") +  plot_layout(guides = 'collect') -->

<!-- #bulbulia_summary_graph_many_analysts -->

<!-- ``` -->

## To do

1.  Tidy up graphs and check all labels.

2.  Remove clutter.

3.  Use stronger priors and include stronger prior predictive checks

4.  Sample from an ordinal outcome distribution: obtain un-transformed data from Suzanne NOTE: DONE!, but still need to get church frequency as a monotonic predictor!

5.  Develop discussion about model assumptions and limitations, such as

-   Is the DAG we use here sensible?

-   Measurement equivalence?

-   India???

-   Demand characteristics and heterogeneous populations.

-   Is the theory that religion causes well-being biologically sensible? Why I don't think so...

-   Connect with the literature.

-   Better describe potential for Simpson's paradoxes: country level data collection is likely to give the wrong inference about religion and well being!

-   Note that sociological-level data is what evolutionary scholars are collecting now -- and that such data do not clarify individual-level psychological processes. For individual-level processes we need to measure at the individual level.

-   Make the plug for longitudinal data: we have no understanding of demand characteristics. We get no real inference from the model here because our data are too limited.

-   Make a plug for DAGs, clarify how much trouble we can get into without an explicit causal model.

To be continued...

## Summary

### Individual-level predictions

Church attendance positively predicts anxiety. This is consistent with theories that anxiety leads to greater demand in Church attendance. However, this question awaits future research.

Belief in God is not reliably associated with greater or lower anxiety.

### Group level-predictions

There is substantial variation in country-level intercepts for anxiety. And substantial cultural level variation in religious practice and belief. All this needs to be explained. Finally India is an outlier
