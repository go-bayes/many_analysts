---
title: "Many Analystis Project"
description: 
author:
  - name: Joseph Bulbulia
    url: https://josephbulbulia.netlify.app
    affiliation: Victoria University of Wellington
    affiliation_url: https://www.wgtn.ac.nz
    orcid_id: 0000-0002-5861-2056
date: 2021-APRIL-29 
bibliography: references.bib
link-citations: true
output:
  distill::distill_article:
    self_contained: true
    toc: true
    code_folding: true
    highlight: kate
editor_options: 
  chunk_output_type: console
---


```{r global_options, echo=FALSE, include = FALSE}
# setup
knitr::opts_chunk$set(#
  fig.path="Figs/", 
  message=FALSE, 
  warning=FALSE,
  collapse =TRUE,
  echo=TRUE, 
  #results="hide", 
  fig.width= 16,
  fig.height= 9)
```

```{r runanalysis, echo=FALSE, include = FALSE}
# source("libs.R") # libraries 
# source("funs.R") # custom functions, not used
library("easystats")
library("ggraph")
library("lme4")
library("table1")
library("ggeffects")
library("kableExtra")
library("naniar") # missingness
library("Amelia")
library("patchwork")
library("texreg")
library("viridisLite")
library("patchwork")
library("here")
library("ggthemes")
=library("rstan")
library("brms")
library("bayesplot")
library("bayesplot")
library("dagitty")
library("ggdag")
library("geepack")  # marginal structural models
library("ipw") # inverse probability weighting. 
library("WeightIt")# inverse probability weighting. 
library("emmeans")
library("splines")
library("magick")
library("tidyverse")
library("Amelia")
library("mice")


# Bayes options
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores ())
theme_set(theme_few())
cite_packages(include_R = TRUE)

# citations
# citation("daggity")
# toBibtex(citation("ggdag"))
# print(citation("EValue") , bibtex=TRUE)
```


First, we import the data (see functions). [@tchetgen2012]


## Data import and set up

```{r}
# import data
d <- as.data.frame(
  read.csv(here::here("MARP_data.csv")
  )
)
```



```{r cache = TRUE}
# clean data:use informative names
df <- d %>%
  dplyr::mutate(male2 = ifelse(gender != "man", 1 , 2)) %>% # for index categorical variable, not change of meaning for gender. male and people who do not identify as male.
  dplyr::mutate(male = factor(ifelse(gender != "man", "male" , "notmale"))) %>%
  rename(
    rel_CHURCHFREQ   = rel_1,
    # factor need to recode (eg 7 as 0)// yikes factor transformed into a number
    rel_PRAYERFREQ = rel_2,
    # factor need to recode (eg. 7 as 0)// yikes factor transformed into a number
    IS_RELIIGOUS = rel_3,
    # factor 1 = yes, 2 = no, 3 = atheist// yikes factor transformed into a number
    # NOOO revers scorred (1= religious, 2= not religious, 3=atheist) [R] So note that 3 = religious!!
    BELONGS_DENOMINATION = rel_4,
    # relig
    rel_EXTENTBELIEVEGOD = rel_5,
    # do you belong to a religion or religious denomination? 1 = yes, 2 = no (!)
    rel_EXTENTBELIEVEAFTERLIFE = rel_6,
    rel_EXTENTSPIRITUAL  = rel_7,
    rel_IMPORTANCERELIGIOUSLIFE = rel_8,
    # 1 to five
    rel_IMPORTANCEBELIEVEGOD = rel_9,
    # 1 to five
    wb_genLIFEQUALITY = wb_gen_1,
    # not defined # also remove second underscore, which BRMS doesn't like
    wb_genSATHEALTH = wb_gen_2,
    # not defined
    wb_phyPAIN = wb_phys_1,
    wb_physNEEDSMEDICALTREAT =  wb_phys_2,
    wb_physHASENERGY =  wb_phys_3,
    wb_physMOBILITY = wb_phys_4,
    wb_physSLEEP = wb_phys_5,
    wb_physCANDODAILYACTIVITIES  = wb_phys_6,
    wb_physSATCAPACITYWORK  = wb_phys_7,
    wb_psychENJOYLIFE = wb_psych_1,
    wb_psychMEANING  = wb_psych_2,
    wb_psychCONCENTRATE  = wb_psych_3,
    wb_psychLIKESAPPEARANCE  = wb_psych_4,
    wb_psychSATSELF  = wb_psych_5,
    wb_psychANXIETY  = wb_psych_6,
    wb_socSATPERSONALRELATIONSHIPS  = wb_soc_1,
    wb_socSATSUPPORTFRIENDS  = wb_soc_2
    #   wb_socSATSEX   = wb_soc_3,
  ) %>%
  dplyr::mutate(
    IS_RELIIGOUS = as.factor(IS_RELIIGOUS),
    denomination = as.factor(denomination),
    ethnicity = as.factor(ethnicity),
    country = as.factor(country)
  ) %>%
  dplyr::mutate(
    IS_RELIIGOUS = recode_factor(
      IS_RELIIGOUS,
      "0" = "atheist",
      "0.5" = "not_religious",
      "1" = "religious"
    )
  )
```

```{r}
# get data into shap
d1 <- df %>%
  dplyr::filter(
  ) %>%
  dplyr::mutate(
    anx = as.integer(6- wb_psychANXIETY), # reverse coded! rescale 1-5
    religious = as.integer(IS_RELIIGOUS), #(1= religious, 2= not religious, 3=atheist) [R]
    #put outcome in ST units (see McElreath 2021)  # not necessary
    #age_s = scale(age),
    ch = rel_CHURCHFREQ,
    edu = education,
    bg =  rel_EXTENTBELIEVEGOD#,
  ) %>%
  dplyr::select(anx,
                ch,
                age,
                ses,
                edu,
                bg,
                edu,
                country,
                male,
                religious,
                denomination,
                wb_psychANXIETY)

```

table

```{r}
lt <-table1::table1(~  denomination, data = d1, transpose=F)
lt <-table1::table1(~ ch + religious + age + male + edu + ses + denomination |country, data = d1, transpose=F)
lt
# Table for LaTeX
kable(as.data.frame(lt), booktabs=TRUE, "latex")
```


## Causal Model: belief in God

```{r}
library("ggdag")
library("dagitty")
dg1a <- dagify(
  anx  ~ belief + church  + age + male + ses + country ,
  belief ~ age + church + male + edu + ses  + church + country,
  church ~ age + male + edu + ses + country,
  ses ~ country + age + edu,
  edu ~ country + male + age, 
 # U ~ age + ses + country,
  exposure =  "belief",
  outcome =   "anx",
 # latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events"
  )
)     
dg1a
print( impliedConditionalIndependencies( dg1a ) )
print( adjustmentSets( dg1a,  "belief","anx" ) )
```
'
We adjust for: { church, country, male, ses } . Because we do not have information about education, we condition on the ladder


## Causal model: religious service

```{r}
library("ggdag")
dg2 <- dagify( 
  anx  ~ belief + church  + age + male + ses + country ,
  belief ~ age + church + male + edu + ses  + church + country,
  church ~ age + male + edu + ses + country,
  ses ~ country + age + edu,
  edu ~ country + male + age, 
  exposure =  "church",
  outcome =   "anx",
#  latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events"
  )
) 

%>%
  tidy_dagitty()  

print( impliedConditionalIndependencies( dg2 ) )
print( adjustmentSets( dg1a,  "church", "anx" ) )


## Dag

dpz <- dagify(
  anx  ~ age + belief + church + male + country + ses,
  belief ~ age + male + country + church + ses + edu,
  church ~ age + male + country + ses +edu,
  ses ~ country  + edu,
  edu ~ country + male + age ,
  U ~ age + ses + country,
  exposure =  "church",
  outcome =   "anx",
  latent = "U",
  labels = c(
    "belief" = "belief God",
    "church" = "religious service attendance",
    "anx" = "anxiety",
    "edu" = "education",
    "ses" = "SES",
    "male" = "male",
    "country" = "country",
    "age" = "age",
    "U" = "Unmeasured
    distressing life events"
  )
)


# # graph adjustment sets
dg1<-ggdag::ggdag_adjustment_set(dpz, node_size = 14, text = FALSE, use_labels = "label") +
  theme(legend.position = "bottom") +
  theme_dag() + ggtitle("Adjustment set for religious belief
assuming belief does not change from distress")

dg1
```

We have two adjustment sets: { age, church, country, male, ses } and { church, country, edu, male, ses }

## Multiple imputation 

Missing data can introduce selection bias. 

We examine patterns of missingness and find substantial missingness in denominations

```{r cache = TRUE}
library("naniar")
vis_miss(df) # substantial pattern of missingness in a few variables, 

# save missing file -- this does not work
# ggsave(miss_graph,
#   path = here::here("figs"),
#   width = 16,
#   height = 9,
#   units = "in",
#   filename = "miss_graph.jpg",
#   device = 'jpeg',
#   limitsize = FALSE,
#   dpi = 1200
# )
```

## Impute missing data


```{r cache = TRUE}
set.seed(1234)
prep <- d1 %>% # Remove what we do not need anymore
    arrange(country) %>%
    dplyr::select(anx,
                  ch,
                  age,
                  edu,
                  bg,
                  edu,
                  country,
                  male,
                  anx, 
                  ses)


# check
#table1::table1(~ ch |religious, data = d1)
```

## Impute missingness 

```{r}
library(mice)
library(tidyverse)
d2<-mice(d1)

#d3<-complete(d2)
#saveRDS(d3,here::here("mods","d3"))
#d3 <-readRDS(here::here("mods","d3"))

d4<-d3%>%
  select(anx, ch, bg, age, edu,male,ses,country,religious)%>%
  drop_na()%>%
  mutate(anx_s = scale(anx),
         religious = factor(religious),
         bg_s = scale(bg),
         ch_s = scale(ch),
         age_s = scale(age),
         edu_s = scale(edu),
         ses_s = scale(ses),
         male_2 =scale(as.numeric(male))/2,
         ses_s = scale(ses),
         country=as.factor(country))
```


Imputation of the religion only dataset
```{r}
## MICE ONLY RELIGIOUS
d1r<- d1 %>%
  filter(religious == 3)

hist(d1r$ch)

# save
# saveRDS(d1p, here::here(
#   "mods","d1p"
# ))

d2r<-mice(d1r)

d3r<-complete(d2r)

# Save data 
#saveRDS(d3,here::here("mods","d3r"))
#saveRDS(d3r,here::here("mods","d3r"))

# read data
d3 <-readRDS(here::here("mods","d3"))
d3r <-readRDS(here::here("mods","d3r"))


# Select variables 
d4<-d3%>%
  select(anx, ch, bg, age, edu,male,ses,country,religious)%>%
  drop_na()%>%
  mutate(anx_s = scale(anx),
         bg_s = scale(bg),
         ch_s = scale(ch),
         age_s = scale(age),
         edu_s = scale(edu),
         ses_s = scale(ses),
         male_2 =scale(as.numeric(male))/2,
         ses_s = scale(ses),
         country=as.factor(country),
         religious = as.factor(religious))


d4r<-d3r%>%
  select(anx, ch, bg, age, edu,male,ses,country)%>%
  drop_na()%>%
  mutate(anx_s = scale(anx),
         bg_s = scale(bg),
         ch_s = scale(ch),
         age_s = scale(age),
         edu_s = scale(edu),
         ses_s = scale(ses),
         male_2 =scale(as.numeric(male))/2,
         ses_s = scale(ses),
         country=as.factor(country))
```

Create inverse probability weights

```{r}
library(ipw)


dch <- ipw::ipwpoint(
  exposure = ch_s,
  family = "gaussian",
  numerator = ~ 1,
  denominator = ~ age_s + edu_s + male_2 + ses_s + country,
  trunc = 0.01,
  data = as.data.frame(d4)
)

d1p <- d4 %>% 
  mutate(ipwCH = dch$weights.trunc)

 
# check max value
#max(d1p$ipwCH)


# weighted for religious only

dchr <- ipw::ipwpoint(
  exposure = ch_s,
  family = "gaussian",
  numerator = ~ 1,
  denominator = ~ age_s + edu_s + male_2 + ses_s + country,
  trunc = 0.01,
  data = as.data.frame(d4r)
)

dr <- d4r %>% 
  mutate(ipwCH = dchr$weights.trunc)

# fine, well below 10
#max(dr$ipwCH)
```

## Tables


```{r}
lt <-table1::table1(~ religious|ch_ord, data = dp)
lt
kable(as.data.frame(lt), booktabs=TRUE, "latex")
```



Relable variables

```{r}
dr$ch_ord <- factor(dr$ch, ordered=TRUE)
table(dr$ch_ord)

levels(dr$ch_ord)<-c("never","rarely","1xpy","holydays","1xpm","1xpw",">1xpw")

levels(dr$ch_ord)
is.ordered(dr$ch_ord)

# save
#saveRDS(dr, here::here("mods","dr"))
```

Bayesian model with strong priors


```{r}
b_orR <- brm(
  anx_s|weights(ipwCH) ~ mo(ch_ord) + (1 + mo(ch_ord) | country),
  data = dr,
   prior = c(
    prior(student_t(3, 0, .5), class = Intercept),
    prior(normal(-.05,.1), class = "b"),
    prior(dirichlet(1,1,1,1,1,1), class = "simo", coef = moch_ord1)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  backend = "cmdstanr",
  file = here::here("mods","b_orR")
)

summary(b_orR)

prior_summary(b_orR)


church_plot_R <-plot(ggeffects::ggemmeans(b_or, terms = "ch_ord")) +   xlab("Service attendance (standardised)") + ylab ("Anxiety (standardised)") + labs(title = "Baysian Multi-level Model",
subtitle = "Inverse Probability Weighting") + scale_y_continuous(limits = c(-.5,.5))+ 
  theme_classic()
church_plot_R
```


Graphs


```{r}
### EEMEANS
 b_orR %>% 
  emmeans(~ ch_ord,
          at = list(ch_ord = c("never",">1xpw"),
                    country = NA),
          epred = TRUE) %>% 
  contrast(method = "revpairwise") 
 


 

  
effect_draws_b_orR <-  b_orR %>% 
  emmeans(~ ch_ord,
         at = list(ch_ord = c("never",">1xpw"),
                    country = NA),
          epred = TRUE) %>% 
  contrast(method = "revpairwise") %>%
  gather_emmeans_draws()

     
effect_draws_b_orR %>% mean_hdi() 

#SE = (upper limit – lower limit) / 3.92.

# STANDARD ERROR
Roa <- effect_draws_b_orR %>% mean_hdi() 
(Roa$.upper - Roa$.lower)/3.92 # 

# SE = .0.06751772

library(EValue)
evalues.OLS(-0.208, se = 0.06751772, sd = 1, delta = 1)
#             point    lower     upper
# RR       0.8275548 0.733842 0.9332348
# E-values 1.7101772       NA 1.3484170
bias_plot(0.9332348, xmax = 6)



average_marginal_effectR <- ggplot(effect_draws_b_orR, aes(x = .value)) +
    stat_halfeye(fill = "dodgerblue") +
  labs(x = "Average marginal effect of church attenance on anxiety", y = "Density",
       subtitle = "Marginal effect (never vs. 1xpw): continuous model") +
  theme_classic() +
       scale_x_continuous(limits=c(-.6,.3)) +
  theme(legend.position = "top")

average_marginal_effectR

grand_mean_ameR <- b_orR %>% 
  emmeans(~ ch_ord,
          at = list(ch_ord = c("never",">1xpw")),
          epred = TRUE, re_formula = NA) %>% 
  contrast(method = "revpairwise") %>% 
  gather_emmeans_draws()

plot_grand_mean_ameR <- ggplot(grand_mean_ameR, 
                                   aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(order = 5)) +
  labs(x = "Average marginal effect of church attenance on anxiety", y = "Density",
       subtitle = "Marginal effect (never vs. 1xpw): monotonic model") +
  theme_classic() +
    scale_x_continuous(limits=c(-.6,.3)) +
   theme(legend.position = "bottom",
         legend.title = element_text(size = 5),
          legend.text = element_text(size = 2)) 
plot_grand_mean_ameR



grand_mean_autonomy_distR <- b_orR %>% 
  epred_draws(newdata = expand_grid(ch_ord = c("never",
                                               #"rarely","1xpy","holydays","1xpm","1xpw",
                                               ">1xpw")), 
              re_formula = NA)

plot_grand_mean_ordR <- ggplot(grand_mean_autonomy_distR, 
                                   aes(x = .epred, 
                                       fill = ch_ord)) +
  scale_fill_okabe_ito() +
    stat_halfeye(slab_alpha = 0.7) +
    scale_x_continuous(limits=c(-.6,.4)) +
  labs(x = "Predicted anxiety (standardised)", y = "Density",
       fill = "Church frequency",
       subtitle = "Posterior predictions: monotonic model") +
  theme_classic() +
     theme(legend.position = "bottom",
         legend.title = element_text(size = 12),
          legend.text = element_text(size = 8)) 

graph_r<- plot_grand_mean_ameR + plot_grand_mean_ordR + plot_annotation(tag_levels = "a",  title = "Religious only model")
yola


ggsave(
  graph_r,
  path = here::here("figs"),
  width = 12,
  height = 6,
  units = "in",
  filename = "graph_r.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)


```

##  Gee models of various sorts


```{r}
library(splines)
ipb_ch_ln_no_mediation <- geeglm(
  anx_s ~ ch,
  data = d1p,
  id = country,
  corstr = "exchangeable",
  weights = ipwCH
)


## Model misspecification 
ipb_ch_ln_mediation <- geeglm(
  anx_s ~ ch + religious,
  data = d1p,
  id = country,
  corstr = "exchangeable",
  weights = ipwCH
)
saveRDS(ipb_ch_ln_mediation, here::here("mods","ipb_ch_ln_mediation"))
saveRDS(ipb_ch_ln_no_mediation, here::here("mods","ipb_ch_ln_no_mediation"))


model_parameters(ipb_ch_ln_mediation)
model_parameters(ipb_ch_ln_no_mediation)


plot(ggeffects::ggemmeans(ipb_ch_ln_mediation, terms = "ch"), add.data = TRUE)


ipb_ch<- geeglm(
  anx_s ~  bs(ch),
  data = d1p,  
  id = country,
  corstr = "exchangeable",
  weights = ipwCH
)
saveRDS(ipb_ch, here::here("mods","ipb_ch"))
model_parameters(ipb_ch)

plot(ggeffects::ggemmeans(ipb_ch, terms = "ch[all]"), add.data = TRUE
     )

# splines
library(splines)
ipb_ch_lnR<- geeglm(
  anx_s ~ ch,
  data = dr,
  id = country,
  corstr = "exchangeable",
  weights = ipwCH
)
#saveRDS(ipb_ch_lnR, here::here("mods","ipb_ch_lnR"))
model_parameters(ipb_ch_lnR)

plot(ggeffects::ggemmeans(ipb_ch_lnR, terms = "ch"), add.data = TRUE
     )

ipb_chR<- geeglm(
  anx_s ~  bs(ch),
  data = dr,  
  id = country,
  corstr = "exchangeable",
  weights = ipwCH
)
saveRDS(ipb_chR, here::here("mods","ipb_ch"))
model_parameters(ipb_chR)

plot(ggeffects::ggemmeans(ipb_chR, terms = "ch[all]"), add.data = TRUE
     )

abs(min(d1p$ch_s) - max(d1p$ch_s))
# 3.064032

# sensitivity
evalues.OLS(0.04, se = 0.01, sd = 1, delta = 1.4)
bias_plot(1.3009531, xmax = 6)


### Religious Only 

library(splines)
r_gee <- geeglm(
  anx_s ~ ch, # retain scale
  data = dr,
  id = country,
  corstr = "exchangeable",
  weights = ipwCH
)
saveRDS(r_gee, here::here("mods","r_gee"))


hist(dr$ch)


# model_parameters(ipb_bg)

model_parameters(r_gee) # no effect

min(dr$ch_s) + max(dr$ch_s)

# sensitivity
library(EValue)
evalues.OLS(0.2238435, se = 0.01, sd = 1, delta = 1.4)

#bias_plot(0.2238435, xmax = 6)




# An E-value for unmeasured confounding is minimum strength of association, on the risk ratio scale, that unmeasured confounder(s) would need to have with both the treatment and the outcome to fully explain away a specific treatment–outcome association, conditional on the measured covariates.
# 
# The estimate is converted appropriately before the E-value is calculated. See conversion functions for more details. The point estimate and confidence limits after conversion are returned, as is the E-value for the point estimate and the confidence limit closest to the proposed "true" value (by default, the null value.)
# 
# For an OLS() estimate, the E-value is for linear regression with a continuous exposure and outcome. Regarding the continuous exposure, the choice of delta defines essentially a dichotomization in the exposure between hypothetical groups of subjects with exposures equal to an arbitrary value c versus to another hypothetical group with exposures equal to c + delta.
# 
# For example, if resulting E-value is 2, this means that unmeasured confounder(s) would need to double the probability of a subject's having exposure equal to c + delta instead of c, and would also need to double the probability of being high versus low on the outcome, in which the cutoff for "high" versus "low" is arbitrary subject to some distributional assumptions (Chinn, 2000).
```


### Bayesian Stratified Regression 

Not used


```{r}
listout <- readRDS(here::here("mods","listout"))
modmc <- brm_multiple(
  anx_s ~ ch_s + age_s + edu_s + male_2 +ses_s + (1 + ch_s | country),
  data = listout,
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  backend = "cmdstanr",
  file=  here::here("mods", "modmc.rds"),
  threads = threading(4)
)

summary(modmc)
```



## Bayesian wieghted regression 

```{r}
listout <- readRDS(here::here("mods","listout"))
modmc_wt_linear <- brm(
  anx_s|weights(ipwCH) ~ ch_s + (1 + ch_s | country),
  data = d1p,
    prior = c(
    prior(normal(0, .1), class = Intercept),
    prior(normal(-.1,.1), class = b)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  backend = "cmdstanr",
  file = here::here("mods","modmc_wt_linear")
)
#saveRDS(modmc, here::here("mods", "modmc.rds"))
summary(modmc_wt_linear)
```

Priors used

```{r}
prior_summary(modmc_wt_linear)
```

Use of strong prior and splines

```{r}
library(brms)
library(splines)

listout <- readRDS(here::here("mods","listout"))
modmc_wt_priorStrong <- brm(
  anx_s|weights(ipwCH) ~ bs(ch_s) + (1 + ch_s | country),
  data = d1p,
    prior = c(
    prior(student_t(3, 0,.25), class = Intercept),
    prior(normal(-.05, .1), class = b)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  backend = "cmdstanr",
  file = here::here("mods","modmc_wt_priorStrong")
)

## Table
parameters::parameters(
  modmc_wt_priorStrong,
  test = "pd",
  component = "all",
  priors = FALSE, 
  ci_method = "hdi",
#  effects = "fixed",
  group_level = FALSE,
  diagnostic = "Rhat") %>%
    mutate_if(is.numeric, ~ round(., 3)) %>%
    mutate_all(funs(str_replace(., "b_", ""))) %>%
    mutate_all(funs(str_replace(., "bs", ""))) %>%
    kable(booktabs = T, "latex", caption =  "Parameter estimates for continuous (spline) model of religious service on anxiety") %>%
    print()

# prior summary

prior_summary(modmc_wt_priorStrong)
```

Test strong priors on non-linear model

```{r}
##### TeST PRIORS
modmc_wt_priorStrong_TEST <- brm(
  anx_s|weights(ipwCH) ~ bs(ch_s) + (1 + ch_s | country),
  data = d1p,
    prior = c(
    prior(student_t(3, 0,.25), class = Intercept),
    prior(normal(-.05, .1), class = b)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  sample_prior = "only",
  backend = "cmdstanr",
 file = here::here("mods","modmc_wt_priorStrong")
)
```

Test a weaker prior.

```{r}
## Weak prior
modmc_wt_prior_weak <- brm(
  anx_s|weights(ipwCH) ~ bs(ch_s) + (1 + ch_s | country),
  data = d1p,
  prior = c(prior(normal(0, 1), class = b)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  sample_prior = "only",
  backend = "cmdstanr"#,
 # file = here::here("mods","modmc_wt_prior")
)
```


## Graph

```{r, cache = TRUE}
library(viridis)

# make new data
minchur<- min(d1p$ch_s)
maxchur<- max(d1p$ch_s)

# difference
abs(maxchur-minchur)

p0<-brms::conditional_effects(modmc_wt_priorStrong, "ch_s", 
                              spaghetti = T,
                              ndraws = 1000,
                              categorical = F,
                              prob = .95,
                              method = 'fitted')


church_plot <- plot(p0, plot = FALSE)[[1]]   +  xlab("Service attendance (standardised)") + ylab ("Anxiety (standardised)") + labs(title = "Baysian Multi-level Model",
subtitle = "Inverse Probability Weighting") + scale_y_continuous(limits = c(-.5,.5))+ 
  theme_classic()
church_plot
```


### More graphs 

```{r, cache = TRUE}
### EEMEANS
 modmc_wt_priorStrong %>% 
  emmeans(~ ch_s,
          at = list(ch_s = c(-0.8321022,2.23193),
                    country = NA),
          epred = TRUE) %>% 
  contrast(method = "revpairwise") 
 
effect_draws_cn <-  modmc_wt_priorStrong %>% 
  emmeans(~ ch_s,
          at = list(ch_s = c(-0.8321022,2.23193),
                    country = NA),
          epred = TRUE) %>% 
  contrast(method = "revpairwise") %>% 
  gather_emmeans_draws()

# marginal mean 
effect_draws_cn %>% mean_hdi() 


# marginal mean 
effect_draws_cn %>% mean_hdi() 
effect_draws_cn

average_marginal_effect <- ggplot(effect_draws_cn, aes(x = .value)) +
    stat_halfeye(fill = "dodgerblue") +
  labs(x = "Average marginal effect of church attenance on anxiety", y = "Density",
       subtitle = "Marginal effect (never vs. 1xpw): continuous model") +
  theme_classic() +
       scale_x_continuous(limits=c(-.6,.3)) +
  theme(legend.position = "top")

average_marginal_effect

grand_mean <- modmc_wt_priorStrong %>% 
  epred_draws(newdata = expand_grid(ch_s = seq(-0.8321022, 2.23193, by = 0.05)), 
              re_formula = NA)

  plot_grand_mean <- ggplot(grand_mean, 
                                 aes(x = ch_s, y = .epred)) +
  stat_lineribbon() +
  scale_fill_brewer(palette = "Blues") +
  labs(x = "Frequency of religious service attendance (SD)", 
       y = "Predicted anxiety (SD)",
       fill = "95 HPD interval",
       subtitle = "Posterior predictions: continuous model") +
     theme_classic() +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 10),
          legend.text = element_text(size = 8))

plot_grand_mean
plot_result <- average_marginal_effect + plot_grand_mean +  plot_annotation(tag_levels = "a")
plot_result


## Save

ggsave(
  plot_result,
  path = here::here("figs"),
  width = 16,
  height = 9,
  units = "in",
  filename = "plot_result.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)

summary(modmc_wt_priorStrong)
summary(modmc_wt_linear)
#
```

Test evalues


```{r, cache = TRUE}
library(EValue)
summary(ipb_ch_ln)
summary(ipb_ch)
summary(modmc_wt_linear)

# sensitivity = Church

# Obtain standard error 
#SE = (upper limit – lower limit) / 3.92.

ta <- effect_draws_cn %>% mean_hdi() 

(ta$.upper - ta$.lower)/3.92 #
```

Evalue

```{r, cache = TRUE}
evalues.OLS(-0.147 , se = 0.05607611, sd = 1, delta = 1.1)
# 
#              point     lower     upper
# RR       0.8631671 0.7734115 0.9633389
# E-values 1.5870732        NA 1.2368137
```

Bias plot

```{r, cache = TRUE}
#
bias_plot(0.8631671, xmax=5)

multi_bound(multi_bias(confounding()),
                RRAUc = 2.2, RRUcY = 1.7)
```



```{r, cache = TRUE}
d1p<-readRDS(here::here("mods","d1p"))

dchr_sc <- ipw::ipwpoint(
  exposure = ch,
  family = "gaussian",
  numerator = ~ 1,
  denominator = ~ age_s + edu_s + male_2 + ses_s + country,
  trunc = 0.01,
  data = as.data.frame(d1p)
)

dp <- d1p %>% 
  mutate(ipwCH = dchr_sc$weights.trunc
 
# fine, well below 10
max(dp$ipwCH)

```

# Montonic effects model

This is the model reported in the study

```{r}
# bayesian monotonic effects
dp$ch_ord <- factor(dp$ch, ordered=TRUE)
table(dp$ch_ord)

levels(dp$ch_ord)<-c("never","rarely","1xpy","holydays","1xpm","1xpw",">1xpw")

levels(dp$ch_ord)
is.ordered(dp$ch_ord)

#saveRDS(dp, here::here("mods","dp"))
dp<-readRDS(here::here("mods","dp"))
```


## ORDINAL MODEL

```{r}
## Bayesian wieghted regression 
b_or <- brm(
  anx_s|weights(ipwCH) ~ mo(ch_ord) + (1 + mo(ch_ord) | country),
  data = dp,
   prior = c(
    prior(student_t(3, 0, .5), class = Intercept),
    prior(normal(-.05,.1), class = "b"),
    prior(dirichlet(1,1,1,1,1,1), class = "simo", coef = moch_ord1)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  backend = "cmdstanr",
  file = here::here("mods","b_or")
)

summary(b_or)

prior_summary(b_or)
summary(b_or)
```

## Graph ( not used)

```{r}
church_plot <-plot(ggeffects::ggemmeans(b_or, terms = "ch_ord")) +   xlab("Service attendance (standardised)") + ylab ("Anxiety (standardised)") + labs(title = "Baysian Multi-level Model",
subtitle = "Inverse Probability Weighting") + scale_y_continuous(limits = c(-.5,.5))+ 
  theme_classic()
church_plot
```

## Tables

Table usd in the publication

```{r}
parameters::parameters(
  b_or,
  test = "pd",
  component = "all",
  priors = FALSE,
  ci_method = "hdi",
  #  effects = "fixed",
  group_level = FALSE,
  diagnostic = "Rhat"
) %>%
  mutate_if(is.numeric, ~ round(., 3)) %>%
  mutate_all(funs(str_replace(., "b_", ""))) %>%
  mutate_all(funs(str_replace(., "_moch", ""))) %>%
  kable(booktabs = T, "latex", caption =  "Parameter estimates for model of religious service on anxiety") %>%
  print()
```


## Graphs used in the study

```{r}
library(tidybayes)

summary(b_or)
### EEMEANS
b_or %>%
  emmeans( ~ ch_ord,
           at = list(ch_ord = c("never", ">1xpw"),
                     country = NA),
           epred = TRUE) %>%
  contrast(method = "revpairwise")

 



effect_draws <-  b_or %>%
  emmeans( ~ ch_ord,
           at = list(ch_ord = c("never", ">1xpw"),
                     country = NA),
           epred = TRUE) %>%
  contrast(method = "revpairwise") %>%
  gather_emmeans_draws()

# linear model, for EVALUES
effect_draws_or <-  b_or %>%
  emmeans( ~ ch_ord,
           at = list(ch_ord = c("never", ">1xpw"),
                     country = NA),
           epred = TRUE) %>%
  contrast(method = "revpairwise") %>%
  gather_emmeans_draws()
effect_draws_or

# marginal mean 
effect_draws_or %>% mean_hdi() 


# calculate standard error
# 
# se <- function(x) sqrt(var(x) / length(x))
# 
# summary(b_or)
# se(effect_draws_ln$.value)
```

## Graph used in the study

```{r}
library(tidybayes)
library(ggokabeito)   # Neat accessible color palette
# emmeans()-based difference across autonomy
grand_mean_ame <- b_or %>% 
  emmeans(~ ch_ord,
          at = list(ch_ord = c("never",">1xpw")),
          epred = TRUE, re_formula = NA) %>% 
  contrast(method = "revpairwise") %>% 
  gather_emmeans_draws()

plot_grand_mean_ame <- ggplot(grand_mean_ame, 
                                   aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(order = 5)) +
  labs(x = "Average marginal effect of church attenance on anxiety", y = "Density",
       subtitle = "Marginal effect (never vs. 1xpw): monotonic model") +
  theme_classic() +
    scale_x_continuous(limits=c(-.6,.3)) +
   theme(legend.position = "bottom",
         legend.title = element_text(size = 5),
          legend.text = element_text(size = 2)) 

plot_grand_mean_ame


grand_mean_autonomy_dist <- b_or %>% 
  epred_draws(newdata = expand_grid(ch_ord = c("never","rarely","1xpy","holydays","1xpm","1xpw",">1xpw")), 
              re_formula = NA)


grand_mean_autonomy_dist2 <- b_or %>% 
  epred_draws(newdata = expand_grid(ch_ord = c("never",">1xpw")), 
              re_formula = NA)



plot_grand_mean_ord <- ggplot(grand_mean_autonomy_dist,
                              aes(x = .epred,
                                  fill = ch_ord)) +
  scale_fill_okabe_ito() +
  stat_halfeye(slab_alpha = 0.7) +
  scale_x_continuous(limits = c(-.6, .4)) +
  labs(
    x = "Predicted anxiety (standardised)",
    y = "Density",
    fill = "Church frequency",
    subtitle = "Posterior predictions: monotonic model"
  ) +
  theme_classic() +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8)
  )

plot_grand_mean_ord

plot_grand_mean_ord2 <- ggplot(grand_mean_autonomy_dist2,
                               aes(x = .epred,
                                   fill = ch_ord)) +
  scale_fill_okabe_ito() +
  stat_halfeye(slab_alpha = 0.7) +
  scale_x_continuous(limits = c(-.6, .4)) +
  labs(
    x = "Predicted anxiety (standardised)",
    y = "Density",
    fill = "Church frequency",
    subtitle = "Posterior predictions: monotonic model"
  ) +
  theme_classic() +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 8)
  )

plot_grand_mean_ord2



# Save plot
ggsave(
  plot_result_ord,
  path = here::here("figs"),
  width = 12,
  height = 6,
  units = "in",
  filename = "plot_result_ord.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)


plot_result_ord2 <- plot_grand_mean_ame + plot_grand_mean_ord2+  plot_annotation(tag_levels = "a")
plot_result_ord2



ggsave(
  plot_result_ord2,
  path = here::here("figs"),
  width = 12,
  height = 6,
  units = "in",
  filename = "plot_result_ord2.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)


plot_result_full <- (average_marginal_effect + plot_grand_mean)/
 (plot_grand_mean_ame + plot_grand_mean_ord) + plot_annotation(tag_levels = "a")
plot_result_full


ggsave(
  plot_result_full,
  path = here::here("figs"),
  width = 10,
  height =10,
  units = "in",
  filename = "plot_result_full.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1000
)
```

More evalues 

```{r}
# Obtain evalues

# marginal mean 
effect_draws_or %>% mean_hdi() 

#SE = (upper limit – lower limit) / 3.92.

oa <- effect_draws_or %>% mean_hdi() 
(oa$.upper - oa$.lower)/3.92 # 

# SE = .075

library(EValue)
evalues.OLS(-0.187 , se = .06733407, sd = 1, delta = 1)

#             point     lower     upper
# RR       0.8435214 0.7482451 0.9509295
# E-values 1.6544616        NA 1.2845523


#SE = (upper limit – lower limit) / 3.92.

ta <- effect_draws_cn %>% mean_hdi() 
ta
(ta$.upper - ta$.lower)/3.92 # 



evalues.OLS(-0.147  , se =  0.05607611, sd = 1, delta = 1.1)
#              point     lower     upper
# RR       0.8631671 0.7734115 0.9633389
# E-values 1.5870732        NA 1.2368137
```


### Test priors ordinal model


```{r}
##### TeST PRIORS
b_ord_test_weak_priors <- brm(
  anx_s|weights(ipwCH) ~ mo(ch_ord) + (1 + mo(ch_ord) | country),
  data = dp,
  prior = c(
    prior(student_t(3, 0, 2.5), class = Intercept),
    prior(normal(0,1), class = "b"),
    prior(dirichlet(1,1,1,1,1,1), class = "simo", coef = moch_ord1)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  sample_prior = "only",
  backend = "cmdstanr"
)




plot_ord_wk_priors <-
  brms::conditional_effects(
    b_ord_test_weak_priors,
    "ch_ord",
    spaghetti = T,
    ndraws = 1000,
    categorical = F,
    prob = .95,
    method = 'fitted'
  )

test_or_wk <-
  plot(plot_ord_wk_priors, plot = FALSE)[[1]]   +  xlab("Service attendance (monotonic)") + ylab ("Anxiety (standardised)") + labs(title = "Check Priors: Baysian Mixed Effects Marginal Model", subtitle = "Sampling from weak priors only (ordinal) ") + scale_y_continuous(limits = c(-20, 15)) +
  theme_classic()
test_or_wk




d1p<-readRDS(here::here("mods","d1p"))
dp<-readRDS(here::here("mods","dp"))


b_cont_test_st_priors <- brm(
  anx_s|weights(ipwCH) ~ bs(ch_s) + (1 + ch_s | country),
  data = d1p,
    prior = c(
    prior(student_t(3, 0,.25), class = Intercept),
    prior(normal(-.05, .1), class = b)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  sample_prior = "only",
  backend = "cmdstanr"#,
 # file = here::here("mods","b_cont_test_st_priors")
)



con_st_priors <-
  brms::conditional_effects(
    b_cont_test_st_priors,
    "ch_s",
    spaghetti = T,
    ndraws = 1000,
    categorical = F,
    prob = .95,
    method = 'fitted'
  )

test_con_st <-
  plot(con_st_priors, plot = FALSE)[[1]]   +  xlab("Service attendance (sd)") + ylab ("Anxiety (standardised)") + labs(title = "Check Priors: Baysian Mixed Effects Marginal Model", subtitle = "Sampling from weak priors only (continuous) ") +   scale_y_continuous(limits = c(-10, 10)) +
  theme_classic()




b_cont_test_wk_priors <- brm(
  anx_s | weights(ipwCH) ~ bs(ch_s) + (1 + ch_s | country),
  data = d1p,
  prior = c(prior(normal(0, 2.5), class = Intercept),
            prior(normal(0, 1), class = b)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  sample_prior = "only",
  backend = "cmdstanr"#
)





con_wk_priors <-
  brms::conditional_effects(
    b_cont_test_wk_priors,
    "ch_s",
    spaghetti = T,
    ndraws = 1000,
    categorical = F,
    prob = .95,
    method = 'fitted'
  )

test_con_wk_priors <-
  plot(con_wk_priors, plot = FALSE)[[1]]   +  xlab("Service attendance (sd)") + ylab ("Anxiety (standardised)") + labs(title = "Check Priors: Baysian Mixed Effects Marginal Model", subtitle = "Sampling from weak priors only (continuous) ")   + scale_y_continuous(limits = c(-10, 10)) +
  theme_classic()
test_con_wk_priors



## THIS IS IT.  TO MAKE WEAKER INCREASE INTERCEPT
b_or_test_st_priors4 <- brm(
  anx_s | weights(ipwCH) ~ mo(ch_ord) + (1 + mo(ch_ord) | country),
  data = dp,
  seed = 1234,
  prior = c(
    prior(student_t(3, 0, .5), class = Intercept),
    prior(normal(-.05, .1), class = "b"),
    prior(dirichlet(1, 1, 1, 1, 1, 1), class = "simo", coef = moch_ord1)
  ),
  warmup = 1000,
  iter = 2000,
  chains = 4,
  sample_prior = "only",
  backend = "cmdstanr"#,
  # file = here::here("mods","b_or_test_st_priors4")
)

prior_summary(b_or_test_st_priors4)




b_or_test_st_priors4 <-
  brms::conditional_effects(
    b_or_test_st_priors4,
    "ch_ord",
    spaghetti = T,
    ndraws = 1000,
    categorical = F,
    prob = .95,
    method = 'fitted'
  )

or_strong <-
  plot(b_or_test_st_priors4, plot = FALSE)[[1]]   +  xlab("Service attendance (monotonic)") + ylab ("Anxiety (standardised)") + labs(title = "Check Priors: Baysian Mixed Effects Marginal Model", subtitle = "Sampling from strong priors only (ordinal) ") + scale_y_continuous(limits = c(-20, 15)) +
  theme_classic()
or_strong

#saveRDS(modmc, here::here("mods", "modmc.rds"))


# Graph
library(patchwork)

test_priors <-(test_or_wk + or_strong )/(test_con_wk_priors+test_con_st) + plot_annotation(tag_levels = "a")

test_priors

ggsave(
  test_priors,
  path = here::here("figs"),
  width = 12,
  height = 12,
  units = "in",
  filename = "test_priors.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)

```



## More priors tested

```{r}
library(brms)
library(splines)

listout <- readRDS(here::here("mods","listout"))
modmc_wt_priorStrong <- brm(
  anx_s|weights(ipwCH) ~ bs(ch_s) + (1 + ch_s | country),
  data = d1p,
  prior = c(
    prior(normal(0, .1), class = Intercept),
    prior(normal(-.1,.1), class = b)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  backend = "cmdstanr",
  file = here::here("mods","modmc_wt_priorStrong")
)


##### TeST PRIORS
modmc_wt_priorStrong_TEST <- brm(
  anx_s|weights(ipwCH) ~ bs(ch_s) + (1 + ch_s | country),
  data = d1p,
  prior = c(
    prior(normal(0, .1), class = Intercept),
    prior(normal(-.1,.1), class = b)),
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  sample_prior = "only",
  backend = "cmdstanr"#,
 # file = here::here("mods","modmc_wt_priorStrong")
)
#saveRDS(modmc, here::here("mods", "modmc.rds"))
summary(modmc_wt_prior)
prior_summary(modmc_wt_prior)
summary(modmc_wt_priorStrong)


```

### Checks:

```{r}
# YES
pp_check(b_ln)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(b_ln,
          type = "trace")
```


### Images for DAGS in the study 

Made in TikZ, rendered in Magick and ggplot2


```{r}
library(ggplot2)
library(magick)
library(patchwork)

dag1 <- image_ggplot(image_read(here::here("figs","dg_1.tiff")),
                     interpolate = T)
dag1
dag2 <- image_ggplot(image_read(here::here("figs","dg_2.tiff")), interpolate = T)
dag2
dag3 <- image_ggplot(image_read(here::here("figs","dg_3.tiff")), interpolate = T)
dag3
dag4 <- image_ggplot(image_read(here::here("figs","dg_4.tiff")),
                     interpolate = T)
dag4
library(patchwork)
daggraph <- dag1 + dag4 + dag3  / ( dag2) + 
  plot_annotation(title = "Directed Acyclic Graphs (DAGs) clarify assumptions and hazards for causal identification", tag_levels = "a")
  
ggsave(
  daggraph,
  path = here::here("figs"),
  width = 10,
  height = 5,
  units = "in",
  filename = "daggraph.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)
```



## DETAILS OF ANLAYSIS FROM PREVIOUS ITERATIONS OF THE STUDY

## Workflow and analysis

First, we inspect the data. A challenge is that many columns data have been transformed from their raw form into a number between 0 and 1. Later we'll see that these transformations render the modelling less reliable than if the data were retained.

So for the next iteration, we'll need the data as they were recorded. Specially we'll focus on the variables such as

> How often do you have negative feelings such as blue mood, despair, anxiety, depression

We'll investigate church frequency and belief in God as predictors of this dimension of well-being.

```{r, echo = FALSE, include = FALSE}
#inspect data frame
str(d) # need to create factors, where factors are needed.
```

```{r, Include = FALSE}
hist(d$rel_1)  # yikes -- factors (church freq was made into a number :(  loss of signal 
hist(d$rel_1)  # yikes -- factors prayer freq was made into a number  :(  loss of signal
```

```{r, include = FALSE}
table(d$rel_3,useNA = "ifany") # This is absolutely not good. 
```

```{r include = FALSE}
#  need to recode factors -- NAs should be NAs, otherwise, we should describe them as missingness, so will avoid these variables
table(d$ethnicity,  useNA = "ifany") # need recode NA as "not identified"
table(d$denomination, useNA = "ifany") # need recode NA as "no denomination" 
# fix
d$denomination[is.na(d$denomination)] <- "not_reported"
d$ethnicity[is.na(d$ethnicity)] <- "not_reported"
#d$wb_soc_3[is.na(d$wb_soc_3)] <- "not_reported" # Sat with sex
```

```{r, include = FALSE}
# what are the numbers here? 
table(d$attention_check, useNA = "ifany")
d$wb_phys_mean
```

## Missingness

Next we need to examine patterns of missing-ness, which might spoil inference.

```{r cache = TRUE}
library("naniar")
vis_miss(df) # substantial pattern of missingness in a few variables, 
gg_miss_upset(df)
```

There is little missingness so we will use only complete cases. Note that it would be better to have a method for handling the uncertainty of missingness. Missing data should be handled by some probabilistic imputation strategy. However, because there are many larger problems about measurement error, sampling, and theory, lets set these to questions to the side and work with the complete dataset

```{r, include = FALSE}
# get columns for different indicators 
rel <- get_rel_vars(df)
wbgen <- get_wb_gen(df)
wbphys <- get_wb_phys(df)
wbpsych <- get_wb_psych(df)
wbsoc <- get_wb_soc(df)

```

Next some exploration Graphs. Inspecting the sample responses on religion.

```{r, cache = TRUE, echo = FALSE}
head(rel)
r1 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_CHURCHFREQ,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Church Frequency") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r1

r2 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_PRAYERFREQ,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Prayer Frequency") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r2

r3 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_EXTENTBELIEVEGOD,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Extent Believe in God") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))

r3

r4 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_EXTENTBELIEVEAFTERLIFE,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Extent Believe in Afterlife") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r4

r5 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_EXTENTSPIRITUAL,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Extent Spiritual") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r5

r6 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_IMPORTANCERELIGIOUSLIFE,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  scale_color_viridis(discrete = TRUE) +
  ggtitle("Importance of Religious Life") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r6


r7 <- rel %>%
  ggplot(aes(
    x = country,
    y = rel_IMPORTANCEBELIEVEGOD,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  ggtitle("Importance Believe in God") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 30))
r7
```

```{r, cache = TRUE, include = FALSE}
library("patchwork")
(
  r1 + r2  +  r3
)/  (r4  + r5) / (r6 +  r7)   +  plot_annotation(tag_levels = 'A') + plot_layout(guides = "collect")
```

Substantial between country variation evident. India = very high

Let's look at the anxiety indicator: India is much lower: .

```{r}
wbpsych
wb1 <- wbpsych %>%
  ggplot(aes(
    x = country,
    y = 6 - wb_psychANXIETY, # reverse code
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  ggtitle("Importance Believe in God") +
  ylab("") + 
  theme(axis.text.x = element_text(angle = 30))
wb1

```

We're interested in meaning of life as a causal mediator of anxiety

```{r}
wb2 <- wbpsych %>%
  ggplot(aes(
    x = country,
    y = wb_psychMEANING,
    group = country,
    color = country
  )) +
  geom_boxplot(notch = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  geom_point(position = "jitter", alpha = .1) +
  ggtitle("Importance Believe in God") +
  ylab("") + 
  theme(axis.text.x = element_text(angle = 30))
wb2
```

India again very high, and France is very low. Can we really assume measurement invariance across these countries? Are people so really different? As with any model, we condition on assumptions, however at another iteration of this study, however for now we will assume measurement invariance.

Next, a quick run of correlations. Note that we need the to model the country level dependencies in any correlation matrix, given strong cultural differences

<!-- Religion correlations -->

<!-- ```{r, cache = TRUE} -->

<!-- rel %>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   plot() + theme_blackboard() -->

<!-- ``` -->

<!-- General well-being correlations -->

<!-- ```{r cache = TRUE} -->

<!-- wbgen %>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   plot() + theme_blackboard() -->

<!-- ``` -->

<!-- Physical well-being correlations -->

<!-- ```{r} -->

<!-- wbphys %>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   summary() -->

<!-- wbphys %>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   plot() + theme_blackboard() -->

<!-- ``` -->

<!-- Psychological well-being correlations -->

<!-- ```{r} -->

<!-- wbpsych %>% -->

<!--   select(-wb_psychMEANING)%>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   summary() -->

<!-- wbpsych %>% -->

<!--   select(-wb_psychMEANING)%>% -->

<!--   correlation( partial = FALSE, multilevel = TRUE ) %>% -->

<!--   plot()  + theme_abyss() -->

<!-- ``` -->

#### The statistical model

A bayesian workflow should include prior predictive checks and the use of informative priors (McElreath 2020).

For this initial analysis I am going to use the weakly informative priors that BRMS uses; my experience is that large data sets are resistant to choice of priors. However it is a mistake to trust this experience. For now, though, we must keep to time, and timing is everything.

Additionally, the data have been manipulated in advance of the study to be scaled to a range between 0 and 1. This is a very bad idea. It would be much better to thinking of church attendance frequency as a monotonic effect. I will do that analysis at the next round, if the data are made available in their original form.

Here is the model for church attendance and anxiety

Wrangle data

```{r}
# get data into shape
d1 <- df %>%
  dplyr::filter(
    !is.na(wb_psychANXIETY),
    !is.na(age),
    !is.na(rel_CHURCHFREQ),
    !is.na(wb_psychMEANING),
    !is.na(male),
    !is.na(rel_EXTENTBELIEVEGOD),
  ) %>%
  dplyr::mutate(
    anx = as.numeric(6- wb_psychANXIETY), # recode
    anx_s = scale(wb_psychANXIETY),
    #put outcome in ST units (see McElreath 2021)  # not necessary
    age_s = scale(age),
    ch = rel_CHURCHFREQ,
    mn  = wb_psychMEANING,
    bg =  rel_EXTENTBELIEVEGOD,
    ch_s = scale(rel_CHURCHFREQ),
    mn_s = scale(wb_psychMEANING),
    bg_s = scale(rel_EXTENTBELIEVEGOD)
  ) %>%
  dplyr::select(anx,
                ch,
                mn,
                bg,
                anx_s,
                age_s,
                ch_s,
                mn_s,
                male2,
                country,
                male,
                bg_s,
                wb_psychANXIETY)

## degroup variables for within and between analysis
## https://cran.r-project.org/web/packages/parameters/vignettes/demean.html
d1 <-
  cbind(d1,
        demean(d1, select = c("anx", "ch", "bg"), group = "country"))
```

We might estimate that effects differ within and between groups, but ignoring within and between country heterogeneity and simply pooling effects at the country level

```{r}
m1 <- brm(
  anx_s ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  sample_prior = TRUE,
  data = d1,
  family = "gaussian",
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m1_real_data"
)
parameters::model_parameters(m1, test = "p_direction")
parameters::random_parameters(m1)
```

Greater church attendance is associate with greater anxiety. There is substantial within-group variance, with a low correlation of country-level slope by intercept variances.

```{r cache = TRUE}
p1 <- brms::conditional_effects(
  m1,
  "ch_s",
  spaghetti = T,
  nsamples = 300,
  prob = .89,
  method = 'fitted'
)

plot(p1, plot = FALSE)[[1]] + 
  scale_y_continuous(limits = c(-1, 1))  + 
  xlab("church sd units") + 
  ylab("anxiety in sd units") +
  labs(title = "Predicted effect of ch_s")
```

Before racing ahead, lets do some posterior predictive checks on the model

The trace plots look good.

```{r cache = TRUE}
brms::mcmc_plot(m1,
          type = "trace")
```

However the posterior predictive check reveals that we should work with the original untransformed values of the outcome variable data.

```{r cache = TRUE}
# we see the ordinal qualities of our dataset here
pp_check(m1) # here we pick up the categorical qualities of the distribution
```

For now, we press ahead. Let's graph the location effects

```{r cache = TRUE}
mcmc_plot(m1,
          type = "intervals",
          prob_outer = 0.89)
```

Note: there is huge country-level variability in the MCMC solutions and uncertainty in the correlations between country level intercepts in slopes. How should we interpret these results:

-   Countries have different levels of anxiety;

-   There is variability in the church-level effects on anxiety by country, but this is unreliably correlated with the slope prediction of church-attendance

We'd want to check the priors in this model, and probably use a more informative prior for the correlation of country anxiety and church attendance.

These are our model priors:

```{r}
prior_summary(m1)
```

However we cannot sample from the models priors because some are improper.

```{r}
library(coda)
samples1 <- brms::prior_samples(m1, "b_ch_s")
```

To see this, run the following and note the warning.

```{r eval = FALSE}
m1_prior <- brm(
  anx_s ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  data = d1,
  family = "gaussian",
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m1_prior",
  sample_prior = "only"
)
```

```{r eval= FALSE}
prior_summary(m1)
```

A key problem is the use of uninformative priors

```{r eval = FALSE}
bayestestR::describe_prior(m1)
```

Let's try with an informative prior

```{r cache = TRUE}
m1_prior <- brm(
  anx_s ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  data = d1,
  family = "gaussian",
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m1_prior",
  set_prior("normal(0,.5)", class = "b"),
  sample_prior = "only")
bayestestR::describe_prior(m1_prior)
```

This prior allows positive and negative relationships from -6 to + 4 standard deviations, so would not be informative.

or we can simulate and see that our prior is scattered across five standard deviations of anxiety, and we can see our prior is telling us that anything can happen .

```{r cache = TRUE}
p <- brms::conditional_effects(
  m1_prior,
  "ch_s",
  spaghetti = T,
  nsamples = 1000,
  prob = .89,
  method = 'fitted'
)
plot(p, plot = FALSE)[[1]] + scale_y_continuous(limits = c(-5, 5))  + xlab("church sd units") + ylab ("anxiety in sd units") +
  labs(title = "Expected values for our attempted informative prior reveals remains too flat")
```

Even this prior is diffuse.

We'll return to our priors and sampling distribution at the next iteration of this analysis. Let's set this to the side for now, and focus on the country level variability, looking first at the expectation plots.

#### The group level variances of country

There is lots of variability at the country level intercepts for anxiety. We can see that India is over .5 standard deviations less anxious than the average culture level anxiety. By contrast, Japan, Israel, and France are over .3 standard deviations more anxious than average. There looks to be perhaps some covariance between the country intercepts and slopes... maybe though all estimates crosses zero. We'd either want to use stronger priors or collect data from more countries than are in this sample.

```{r cache = TRUE}
library(see) 
library(parameters) 
par <- parameters::model_parameters(m1, effects = "random")
plot(par,  sort = TRUE) + theme_lucid() #option -->
```

```{r cache = TRUE}
plot(ggeffects::ggpredict(
  m1,
  terms = c("country[all]", "ch_s[minmax]"),
  type = "re",
  ci.lvl = 0.89
))  +  scale_fill_brewer(palette = "Set2") +
  theme_classic()
```

<!-- Let's delving into this question of country level effects by asking whether people who are *relatively* more church attending within their countries tending to have more anxiety.  -->

<!-- - within_church centering = relative church attendance within a country. -->

<!-- - between_church centering = country level differences in church attendance. -->

<!-- ## Within and between -->

<!-- Here's a model that includes within and between country centered variables. See: -->

<!-- https://easystats.github.io/parameters/reference/demean.html -->

<!-- The model. -->

<!-- wb_psychANXIETY -->

<!-- ```{r} -->

<!-- m1a <- brm( -->

<!--   anx_s ~ age_s  + male + ch_within +  ch_between + (1 + ch_within | country), -->

<!--   data = d1, -->

<!--   family = "gaussian", -->

<!--   seed = 1234, -->

<!--   warmup = 1000, -->

<!--   iter = 3000, -->

<!--   chains = 4, -->

<!--   file = "m1_a.rds_real" -->

<!-- ) -->

<!-- parameters::model_parameters(m1a, -->

<!--                              test = "p_direction") -->

<!-- parameters::random_parameters(m1a) -->

<!-- ``` -->

<!-- We find a positive relation of "ch_within" to anxiety.  -->

<!-- ```{r cache = TRUE} -->

<!-- p <- brms::conditional_effects( -->

<!--   m1a, -->

<!--   "ch_within", -->

<!--   spaghetti = T, -->

<!--   nsamples = 3000, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- plot(p, plot = FALSE)[[1]] +  -->

<!--   scale_y_continuous(limits = c(-1, 1)) +  -->

<!--   xlab("church_within") +  -->

<!--   ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of ch_within") -->

<!-- ``` -->

<!-- There is, are somewhat reliable between-country difference, however the effect becomes uncertain at the high end of between-country differences: -->

<!-- ```{r cache = TRUE} -->

<!-- p <- brms::conditional_effects( -->

<!--   m1a, -->

<!--   "ch_between", -->

<!--   spaghetti = T, -->

<!--   nsamples = 3000, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- plot(p, plot = FALSE)[[1]] + scale_y_continuous(limits = c(-1, 1))  + xlab("church_between") + ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of ch_between") -->

<!-- ``` -->

<!-- Before considering this, let's run some model checks on our workflow.  -->

<!-- Trace plots for the model look OK -->

<!-- ```{r} -->

<!--  mcmc_plot(m1a, -->

<!--           type = "trace") -->

<!-- ``` -->

<!-- No surprise, there is the same problem with the sampling distribution. -->

<!-- ```{r} -->

<!-- # we see the ordinal qualities of our dataset here -->

<!-- pp_check(m1a) -->

<!-- ``` -->

<!-- Next the interval plots: -->

<!-- ```{r} -->

<!-- mcmc_plot(m1a, -->

<!--           type = "intervals", -->

<!--           prob_outer = 0.89) -->

<!-- ``` -->

### Ordinal regression: church

```{r}
m1o <- brm(
  wb_psychANXIETY ~ ch_s +
    age_s  +
    male +
    (1 + ch_s | country),
  data = d1,
  family = cumulative(link ="logit"),
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m1o_real"
)
parameters::model_parameters(m1o, test = "p_direction")
parameters::random_parameters(m1o, component = "conditional")
summary(m1o)
```

Focussing on country level variances, we find the slope of the country intercept not reliably correlated with the church attendance slope.

```{r}
summary(m1o)
```

This resolves the problem

```{r}
# YES
pp_check(m1o)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(m1o,
          type = "trace")
```

Model summary

```{r}
parameters::model_parameters(m1o)
```

Plot model, here we see that the effects are driven at the high-end of the anxiety scale. This evidence is consistent with religion as an attractor for people who have high anxiety (see Bulbulia and Sibley 2012, Faith after the Quake)

```{r, cache = TRUE}
library(viridis)
p0b<-brms::conditional_effects(m1o, "ch_s", 
                              spaghetti = T,
                              nsamples = 200,
                              categorical = T,
                              prob = .89,
                              method = 'fitted')


plot(p0b, plot = FALSE)[[1]]   + xlab("ch_s") + ylab ("anxiety 1-5") +
  labs(title = "Predicted effects of ch_s")
# + scale_y_continuous(limits= c(1,5))# +  scale_color_viridis(discrete=TRUE) 
```

<!-- Another plot method -->

<!-- ```{r, cache = TRUE} -->

<!-- library(viridis) -->

<!-- p0b1<-brms::conditional_effects(m1o, "ch_s",  -->

<!--                               spaghetti = T, -->

<!--                               nsamples = 200, -->

<!--                              categorical = F, -->

<!--                               prob = .89, -->

<!--                               method = 'fitted') -->

<!-- plot(p0b1, plot = FALSE)[[1]]   + xlab("ch_s") + ylab ("anxiety 1-5") + -->

<!--   labs(title = "Predicted effects of ch_s")+ scale_y_continuous(limits= c(1,5))# +  scale_color_viridis(discrete=TRUE)  -->

<!-- ``` -->

<!-- ### with demeaning -->

<!-- ```{r} -->

<!-- m1a_o <- brm( -->

<!--   wb_psychANXIETY ~  -->

<!--     age_s  +  -->

<!--     male +  -->

<!--     ch_within +   -->

<!--     ch_between +  -->

<!--     (1 + ch_within|country),   -->

<!--   data = d1, -->

<!--   family = cumulative(link ="logit"), -->

<!--   seed = 1234, -->

<!--   warmup = 1000, -->

<!--   iter = 2000, -->

<!--   chains = 4, -->

<!--   file = "m1a_o_real") -->

<!-- ``` -->

<!-- This resolves the problem -->

<!-- ```{r} -->

<!-- # YES -->

<!-- pp_check(m1a_o) -->

<!-- ``` -->

<!-- Trace plots: -->

<!-- ```{r, cache = TRUE} -->

<!-- mcmc_plot(m1a_o, -->

<!--           type = "trace") -->

<!-- ``` -->

<!-- Model summary -->

<!-- ```{r} -->

<!-- parameters::model_parameters(m1a_o) -->

<!-- ``` -->

<!-- We  find a correlation of within person anxiety intercept by country and within person slope of church attentnce on anxiety, but the correlation is attenuated.  -->

<!-- ```{r, cache = TRUE} -->

<!-- library(viridis) -->

<!-- pch_w <- brms::conditional_effects( -->

<!--   m1a_o, -->

<!--   "ch_within", -->

<!--   spaghetti = T, -->

<!--   nsamples = 200, -->

<!--   categorical = TRUE, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- ppch_w <- -->

<!--   plot(pch_w, plot = FALSE)[[1]]    + ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of Church_within") # +  scale_color_viridis(discrete=TRUE) -->

<!-- ppch_w -->

<!-- ``` -->

<!-- ```{r} -->

<!-- par <- parameters::model_parameters(m1a_o, effects = "random") -->

<!-- plot(par,  sort = TRUE) + theme_lucid() #option -->

<!-- ``` -->

<!-- BETWEEN: Yes, and at the highest levels of anxiety.  -->

<!-- ```{r cache = TRUE} -->

<!-- pch_b <- brms::conditional_effects( -->

<!--   m1a_o, -->

<!--   "ch_between", -->

<!--   spaghetti = T, -->

<!--   nsamples = 200, -->

<!--   prob = .89, -->

<!--   categorical = TRUE, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- ppch_b <- -->

<!--   plot(p, plot = FALSE)[[1]]   + -->

<!--   xlab("ch_between") + ylab ("anxiety: 1-5") + -->

<!--   labs(title = "Predicted effects of Church_between") -->

<!-- ppch_b -->

<!-- ``` -->

<!-- ### Different plot method -->

<!-- Summing over the categories: -->

<!-- ```{r, cache = TRUE} -->

<!-- library(viridis) -->

<!-- p0a<-brms::conditional_effects(m1a_o, "ch_within",  -->

<!--                               spaghetti = T, -->

<!--                               nsamples = 200, -->

<!--                              # categorical = TRUE, -->

<!--                               prob = .89, -->

<!--                               method = 'fitted') -->

<!-- plot(p0a, plot = FALSE)[[1]]   + xlab("bg_within") + ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of bg_within")  + scale_y_continuous(limits = c(1,5))# +  scale_color_viridis(discrete=TRUE)  -->

<!-- ``` -->

<!-- ```{r cache = TRUE} -->

<!-- ps<-brms::conditional_effects(m1a_o, "ch_between",  -->

<!--                               spaghetti = T, -->

<!--                               nsamples = 200, -->

<!--                               prob = .89, -->

<!--                              # categorical = TRUE, -->

<!--                               method = 'fitted') -->

<!-- plot(ps, plot = FALSE)[[1]]   + xlab("bg_between") + ylab ("anxiety: 1-5") +  -->

<!--   labs(title = "Predicted effects of bg_between") + scale_y_continuous(limits = c(1,5)) -->

<!-- ``` -->

### Results: church

```{r cache = TRUE}
p <- brms::conditional_effects(
  m2,
  "bg_s",
  spaghetti = T,
  nsamples = 300,
  prob = .89,
  method = 'fitted')

plot(p, plot = FALSE)[[1]] +
  scale_y_continuous(limits = c(-1, 1))  + 
  xlab("bg_s") + 
  ylab ("anxiety in sd units") +
  labs(title = "Predicted effects of bg_s")

```

How did the model mix? Trace plots look OK

```{r}
 mcmc_plot(m2,
          type = "trace")
```

Again, unsurprisingly we find a same problem with the sampling distribution.

```{r}
# we see the ordinal qualities of our dataset here
pp_check(m2)
```

Note: we'd want to check the priors in this model, and use more informative priors. TBA...

Next the interval plots:

```{r}
mcmc_plot(m2,
          type = "intervals",
          prob_outer = 0.89)
```

Summary:

-   Small individual-level prediction of belief in God on reduced anxiety (though recall our warning about demand characteristics)

## India is an outlier

```{r}
par<-parameters::model_parameters(m2,effects = "random" ) 
plot(par,  sort = TRUE) +theme_lucid()
```

<!-- ```{r cache = TRUE} -->

<!-- p <- brms::conditional_effects( -->

<!--   m2, -->

<!--   "bg_s", -->

<!--   spaghetti = T, -->

<!--   nsamples = 300, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- plot(p, plot = FALSE)[[1]] + scale_y_continuous(limits = c(-1, 1))  + xlab("bg_s") + ylab ("anxiety in sd units") + -->

<!--   labs(title = "Predicted effects of bg_s") -->

<!-- ``` -->

<!-- There country-level variability is all in anxiety, but not in the effect of belief in God. -->

<!-- ```{r cache = TRUE} -->

<!-- plot(ggeffects::ggpredict( -->

<!--   m2, -->

<!--   terms = c("country[all]", "bs_s[minmax]"), -->

<!--   type = "re", -->

<!--   ci.lvl = 0.89 -->

<!-- ))  + -->

<!--   scale_fill_brewer(palette = "Set2") + labs(title = "Predicted effects of bs_s on anxiety") + -->

<!--   scale_y_continuous(limits = c(-1, 1)) -->

<!-- ``` -->

<!-- Next we turn to the "within country relative differences" model for belief in God on anxiety. -->

### Statistical model: belief (Ordinal)

```{r}
m2o <- brm(
  wb_psychANXIETY ~ bg_s +
    age_s  +
    male +
    (1 + bg_s | country),
  data = d1,
  family = cumulative(link = "logit"),
  seed = 1234,
  warmup = 1000,
  iter = 3000,
  chains = 4,
  file = "m2o_real.rds"
)
parameters::model_parameters(m2o, test = "p_direction")
parameters::random_parameters(m2o)
```

This resolves the problem

```{r}
# YES
pp_check(m2o)
```

Trace plots:

```{r, cache = TRUE}
mcmc_plot(m2o,
          type = "trace")
```

Model summary

```{r}
parameters::model_parameters(m2o)
```

Plot model: nothing

```{r, cache = TRUE}
library(viridis)
p0 <- brms::conditional_effects(
  m2o,
  "bg_s",
  spaghetti = T,
  categorical = TRUE,
  nsamples = 200,
  prob = .89,
  method = 'posterior_epred'
)


plot(p0, 
  #  point_args = list(width = .3) ,
  #  points = TRUE,
     plot = FALSE)[[1]]   + xlab("bg") + ylab ("anxiety 1-5") +
  labs(title = "Predicted effects of bg") # +  scale_color_viridis(discrete=TRUE) 
```

<!-- ###  With demeaning NOT NEEDED-->

<!-- ```{r} -->

<!-- m2_o <- brm( -->

<!--   wb_psychANXIETY ~ age_s  + male + bg_within +  bg_between + (1 + ch_within|country),   -->

<!--   data = d1, -->

<!--   family = cumulative(link ="logit"), -->

<!--   seed = 1234, -->

<!--   warmup = 1000, -->

<!--   iter = 3000, -->

<!--   chains = 4, -->

<!--   file = "m2_o_real.rds") -->

<!-- ``` -->

<!-- This resolves the problem -->

<!-- ```{r} -->

<!-- # YES -->

<!-- pp_check(m2_o) -->

<!-- ``` -->

<!-- Trace plots: -->

<!-- ```{r, cache = TRUE} -->

<!-- mcmc_plot(m2_o, -->

<!--           type = "trace") -->

<!-- ``` -->

<!-- Model summary -->

<!-- ```{r} -->

<!-- parameters::model_parameters(m2_o) -->

<!-- ``` -->

<!-- Within: NOTHING -->

<!-- ```{r, cache = TRUE} -->

<!-- library(viridis) -->

<!-- p0bg <- brms::conditional_effects( -->

<!--   m2_o, -->

<!--   "bg_within", -->

<!--   spaghetti = T, -->

<!--   nsamples = 200, -->

<!--   categorical = TRUE, -->

<!--   prob = .89, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- ppbg_w<- plot(p0bg, plot = FALSE)[[1]]   + xlab("bg_within") + ylab ("anxiety 1-5") + -->

<!--   labs(title = "Predicted effects of BeliefGod_within") # +  scale_color_viridis(discrete=TRUE)  -->

<!-- ppbg_w -->

<!-- ``` -->

<!-- BETWEEN: Yes, and at the highest levels of anxiety.  -->

<!-- ```{r cache = TRUE} -->

<!-- pbg <- brms::conditional_effects( -->

<!--   m2_o, -->

<!--   "bg_between", -->

<!--   spaghetti = T, -->

<!--   nsamples = 200, -->

<!--   prob = .89, -->

<!--   categorical = TRUE, -->

<!--   method = 'fitted' -->

<!-- ) -->

<!-- ppbg_b<- plot(pbg, plot = FALSE)[[1]]   + xlab("bg_between") + ylab ("anxiety: 1-5") + -->

<!--   labs(title = "Predicted effects of BeliefGod_between") -->

<!-- ppbg_b -->

<!-- ``` -->

<!-- ## Summary graph -->

<!-- ```{r} -->

<!-- library(patchwork) -->

<!-- ppch_w +  ppbg_w  + ppch_b + ppbg_b + plot_annotation("What is the relationship between belief church and belief on anxiety?", subtitle = "People with greater belief in God have less anxiety accross countries.", tag_levels = "a") +  plot_layout(guides = 'collect') -->

<!-- #bulbulia_summary_graph_many_analysts -->

<!-- ``` -->

## To do

1.  Tidy up graphs and check all labels.

2.  Remove clutter.

3.  Use stronger priors and include stronger prior predictive checks

4.  Sample from an ordinal outcome distribution: obtain un-transformed data from Suzanne NOTE: DONE!, but still need to get church frequency as a monotonic predictor!

5.  Develop discussion about model assumptions and limitations, such as

-   Is the DAG we use here sensible?

-   Measurement equivalence?

-   India???

-   Demand characteristics and heterogeneous populations.

-   Is the theory that religion causes well-being biologically sensible? Why I don't think so...

-   Connect with the literature.

-   Better describe potential for Simpson's paradoxes: country level data collection is likely to give the wrong inference about religion and well being!

-   Note that sociological-level data is what evolutionary scholars are collecting now -- and that such data do not clarify individual-level psychological processes. For individual-level processes we need to measure at the individual level.

-   Make the plug for longitudinal data: we have no understanding of demand characteristics. We get no real inference from the model here because our data are too limited.

-   Make a plug for DAGs, clarify how much trouble we can get into without an explicit causal model.

To be continued...

## Summary

### Individual-level predictions

Church attendance positively predicts anxiety. This is consistent with theories that anxiety leads to greater demand in Church attendance. However, this question awaits future research.

Belief in God is not reliably associated with greater or lower anxiety.

### Group level-predictions

There is substantial variation in country-level intercepts for anxiety. And substantial cultural level variation in religious practice and belief. All this needs to be explained. Finally India is an outlier



```{r}
sim_fun_A = function() {
  n <- 1000
  U <- rnorm(n, 1) # unmeasured distress 
  A <- rnorm(n, 1) # religious service attendance,
  M <- rnorm(n , A + .2 * U)# religious identification
  Y <- rnorm(n , - A *.2 + U *.4) #  distress reduced by attendance.
  
# Religious id, caused by attendance + distress

# simulate data
simdat_A <- data.frame(
  M = M, # rel identification
  A = A, # rel service
  U = U, # distressing events (unmeasured)
  Y = Y )# outcome

sim_A <- lm(Y ~ A + M, data = simdat_A)
sim_A
}

# Replicate including the mediator
r_lm_A <- NA
r_lm_A = replicate(100, sim_fun_A(), simplify = FALSE )


# mediator attenuates true effect ~ .1 instead of ~.1
parameters::pool_parameters(r_lm_A)

## Repeat but with no mediator in model
set.seed(123)
sim_fun_B = function() {
  n <- 1000
  U <- rnorm(n, 1) # unmeasured distress 
  A <- rnorm(n, 1) # religious service attendance,
  M <- rnorm(n , A + .2 * U)# religious identification
  Y <- rnorm(n , - A *.2 + .4 * U) #  distress reduced by attendance.
  
# Simulate data
simdat_B <- data.frame(
  M = M, # rel identification
  A = A, # rel service attendance
  U = U, # distressing events (unmeasured)
  Y = Y ) # outcome

# Only model exposure
sim_B <- lm(Y ~ A, data = simdat_B)
sim_B
}

# Replication 100xs
r_lm_B <- NA
r_lm_B = replicate(100, sim_fun_B(), simplify = FALSE )

# diminished recover true effect ~ .2
parameters::pool_parameters(r_lm_B)


```

